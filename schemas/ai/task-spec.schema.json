{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://ql-rf.io/schemas/ai/task-spec.schema.json",
  "title": "TaskSpec",
  "description": "Structured task specification generated by the meta-prompt engine from user intent",
  "type": "object",
  "required": ["task_type", "goal", "context", "agents", "tools_required", "risk_level", "hitl_required"],
  "properties": {
    "task_type": {
      "type": "string",
      "enum": [
        "drift_remediation",
        "patch_rollout",
        "compliance_audit",
        "incident_investigation",
        "dr_drill",
        "cost_optimization",
        "security_scan",
        "image_management"
      ],
      "description": "The type of infrastructure operation"
    },
    "goal": {
      "type": "string",
      "minLength": 10,
      "maxLength": 500,
      "description": "Clear description of what this task aims to achieve"
    },
    "user_intent": {
      "type": "string",
      "description": "Original user request (for audit trail)"
    },
    "context": {
      "type": "object",
      "required": ["environment", "scope"],
      "properties": {
        "org_id": {
          "type": "string",
          "format": "uuid"
        },
        "environment": {
          "type": "string",
          "enum": ["production", "staging", "development", "sandbox"],
          "description": "Target environment for the operation"
        },
        "scope": {
          "type": "object",
          "properties": {
            "platforms": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": ["aws", "azure", "gcp", "vsphere"]
              },
              "minItems": 1,
              "description": "Cloud platforms in scope"
            },
            "regions": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Regions in scope (e.g., us-east-1, westus2)"
            },
            "asset_filter": {
              "type": "string",
              "description": "Filter expression for assets (e.g., 'role:web-server AND env:prod')"
            },
            "asset_ids": {
              "type": "array",
              "items": { "type": "string", "format": "uuid" },
              "description": "Explicit list of asset IDs (alternative to filter)"
            }
          }
        }
      }
    },
    "agents": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["name"],
        "properties": {
          "name": {
            "type": "string",
            "enum": [
              "drift_agent",
              "patch_agent",
              "compliance_agent",
              "incident_agent",
              "dr_agent",
              "cost_agent",
              "security_agent",
              "image_agent"
            ]
          },
          "priority": {
            "type": "integer",
            "minimum": 1,
            "maximum": 10,
            "default": 1
          }
        }
      },
      "minItems": 1,
      "description": "Specialist agents to invoke for this task"
    },
    "tools_required": {
      "type": "array",
      "items": { "type": "string" },
      "minItems": 1,
      "description": "Tools the agent(s) will need to complete the task"
    },
    "risk_level": {
      "type": "string",
      "enum": ["low", "medium", "high", "critical"],
      "description": "Risk classification for this task"
    },
    "hitl_required": {
      "type": "boolean",
      "description": "Whether human approval is required before execution"
    },
    "constraints": {
      "type": "object",
      "properties": {
        "canary_required": {
          "type": "boolean",
          "default": false,
          "description": "Require canary phase before full rollout"
        },
        "max_batch_percent": {
          "type": "integer",
          "minimum": 1,
          "maximum": 100,
          "default": 20,
          "description": "Maximum percentage of assets per batch"
        },
        "max_batch_size": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum number of assets per batch"
        },
        "rollback_trigger": {
          "type": "string",
          "description": "Condition that triggers automatic rollback (e.g., 'error_rate > 1%')"
        },
        "maintenance_window": {
          "type": "object",
          "properties": {
            "start": { "type": "string", "format": "time" },
            "end": { "type": "string", "format": "time" },
            "timezone": { "type": "string" }
          },
          "description": "Allowed execution window"
        },
        "exclude_assets": {
          "type": "array",
          "items": { "type": "string", "format": "uuid" },
          "description": "Assets to exclude from operation"
        }
      }
    },
    "validation": {
      "type": "object",
      "properties": {
        "schema": {
          "type": "string",
          "description": "Schema to validate plan output against (e.g., 'drift_plan_v1')"
        },
        "policies": {
          "type": "array",
          "items": { "type": "string" },
          "description": "OPA policies to apply (e.g., ['production_safety', 'drift_delta_check'])"
        }
      }
    },
    "execution_policy": {
      "type": "object",
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["plan_only", "canary_only", "full_auto"],
          "default": "plan_only",
          "description": "Autonomy level for this task"
        },
        "allowed_approver_roles": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Roles that can approve this task"
        },
        "require_two_approvers": {
          "type": "boolean",
          "default": false,
          "description": "Require two separate approvals"
        }
      }
    },
    "llm_profile": {
      "type": "object",
      "properties": {
        "model": {
          "type": "string",
          "description": "LLM model used (e.g., 'claude-3.5-sonnet')"
        },
        "agent_version": {
          "type": "string",
          "description": "Agent version (e.g., 'drift_agent@1.2.0')"
        },
        "prompts_version": {
          "type": "string",
          "description": "Prompts version (e.g., '2024-12-01')"
        }
      },
      "description": "Versioning info for regression tracking"
    },
    "timeout_minutes": {
      "type": "integer",
      "minimum": 1,
      "maximum": 1440,
      "default": 30,
      "description": "Maximum time for task completion"
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "context": {
            "properties": {
              "environment": { "const": "production" }
            }
          }
        }
      },
      "then": {
        "properties": {
          "risk_level": { "enum": ["high", "critical"] },
          "hitl_required": { "const": true }
        }
      }
    }
  ]
}
