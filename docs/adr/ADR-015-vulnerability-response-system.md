# ADR-015: Real-Time Vulnerability Response System

## Status
Accepted

## Context

Enterprise organizations face significant challenges with vulnerability management:

1. **Detection Latency**: CVEs are published in NVD/OSV but organizations take days/weeks to discover affected assets
2. **Blast Radius Complexity**: Understanding which images and assets are affected requires traversing SBOM → Image → Asset relationships
3. **Image Lineage**: Child images inherit parent vulnerabilities, multiplying impact
4. **Manual Remediation**: Patching is often manual, error-prone, and lacks rollback capability
5. **Compliance Evidence**: Auditors require proof of timely vulnerability response (PCI-DSS, HIPAA)
6. **Alert Fatigue**: Security teams overwhelmed with low-priority CVEs without proper prioritization

Current state:
- SBOM tracking exists in `sbom_packages` and `sbom_vulnerabilities`
- Image lineage tracking exists in `image_lineage`
- Platform patching capabilities exist (AWS SSM, Azure Update Manager, GCP OS Config)
- AI agents can generate patch plans

Missing:
- Proactive CVE discovery from external feeds
- Automated blast radius calculation
- Urgency scoring for prioritization
- Orchestrated patch campaigns with phased rollout
- Auto-rollback on failure

## Decision

We implement a **Real-Time Vulnerability Response System** with the following components:

### 1. CVE Feed Aggregator Service

New microservice (`services/cve-aggregator/`) that:

**Feed Sources**:
| Source | Type | Update Frequency | Data |
|--------|------|------------------|------|
| NVD | Official | Every 2 hours | CVSS, CPE, references |
| OSV | Community | Every 1 hour | Ecosystem-specific packages |
| GitHub Advisories | Official | Real-time | Package ecosystem advisories |
| CISA KEV | Official | Daily | Known exploited vulnerabilities |

**Processing Pipeline**:
```
Feed Polling → Normalization → Deduplication → Package Matching → Alert Creation
```

**CVE Cache Schema**:
```go
type CVECache struct {
    ID                uuid.UUID
    CVEID             string        // "CVE-2024-21626"
    Source            string        // "nvd", "osv", "github", "cisa_kev"
    PublishedDate     time.Time
    LastModifiedDate  time.Time
    CVSSScore         float64       // 0.0-10.0
    CVSSSeverity      string        // "CRITICAL", "HIGH", "MEDIUM", "LOW"
    CVSSVector        string        // CVSS v3.1 vector string
    EPSSScore         float64       // 0.0-1.0 (probability of exploitation)
    EPSSPercentile    float64       // Percentile ranking
    CISAKnownExploit  bool          // In CISA KEV list
    ExploitAvailable  bool          // Known exploit exists
    AffectedPackages  []AffectedPackage
    References        []Reference
}
```

### 2. Blast Radius Engine

Calculates vulnerability impact by traversing the dependency graph:

**Algorithm**:
```
1. CVE → Find affected packages in sbom_packages (by CPE/PURL)
2. Packages → Find images via sbom_id
3. Images → Propagate through image_lineage (children inherit parent CVEs)
4. Images → Find assets via image_coordinates + assets.image_ref
5. Calculate urgency score
```

**Image Lineage Propagation**:
- Parent images with vulnerabilities propagate to ALL child images
- Direct vs inherited tracking (`is_direct` flag)
- Lineage depth tracking for prioritization

### 3. Urgency Scoring

Prioritization formula combining multiple risk factors:

```
UrgencyScore = (
    CVSSScore × 10 +           // 0-100 from CVSS
    ExploitAvailable × 25 +    // +25 if known exploit
    CISAKnown × 20 +           // +20 if in CISA KEV
    ProductionWeight × 15 +    // +15 if affects production
    AssetCountFactor × 10 +    // 0-10 based on % of fleet
    EPSSScore × 20             // 0-20 from EPSS probability
) / 2  // Normalize to 0-100
```

**Urgency Levels**:
- **Critical** (≥80): Active exploitation, production impact
- **High** (≥60): Known exploit or high CVSS
- **Medium** (≥40): Moderate risk, scheduled remediation
- **Low** (<40): Monitor, patch in next cycle

### 4. CVE Alert Management

Alert lifecycle for tracking vulnerability response:

**Alert States**:
- `new` → Initial detection
- `investigating` → Security team reviewing
- `acknowledged` → Confirmed, planning response
- `remediation_in_progress` → Patch campaign active
- `resolved` → Vulnerability patched
- `false_positive` → Determined not applicable
- `risk_accepted` → Accepted with compensating controls

**Alert Schema**:
```go
type CVEAlert struct {
    ID                uuid.UUID
    OrgID             uuid.UUID
    CVEID             string
    Severity          string
    UrgencyScore      float64
    Status            string
    AffectedPackages  int
    AffectedImages    int
    AffectedAssets    int
    ProductionAssets  int
    FirstDetectedAt   time.Time
    ResolvedAt        *time.Time
}
```

### 5. Patch Campaign Orchestration

Phased rollout with automatic health checks and rollback:

**Rollout Strategies**:
| Strategy | Description | Use Case |
|----------|-------------|----------|
| `canary` | 5% → 25% → 50% → 100% | Production critical |
| `rolling` | Wave-based with health gates | General production |
| `blue_green` | Full parallel deployment | Zero-downtime required |
| `immediate` | All at once | Emergency patches |

**Campaign Phases**:
```
1. Canary (5% of assets)
   → Health checks (error rate, latency, CPU/memory)
   → Continue or rollback

2. Wave 1 (25% of remaining)
   → Health checks
   → Continue or rollback

3. Wave 2 (50% of remaining)
   → Health checks
   → Continue or rollback

4. Full Rollout (remaining assets)
   → Final health validation
```

**Health Check Framework**:
- HTTP endpoint checks
- AWS CloudWatch metrics
- Azure Monitor metrics
- Prometheus queries
- Custom webhook checks

**Auto-Rollback Triggers**:
- Error rate exceeds threshold (default: 5%)
- P99 latency exceeds baseline + 2σ
- Health check failure rate > 10%
- Manual intervention

### 6. Vulnerability Agent

New AI agent (`services/orchestrator/internal/agents/vulnerability_agent.go`):

**Capabilities**:
- Analyze CVE alerts and blast radius
- Recommend patch priority based on urgency score
- Generate patch campaign plans
- Coordinate with Patch Agent for execution
- Create compliance evidence

**Tools**:
- `list_cve_alerts` - Query alerts with filters
- `get_cve_details` - Detailed CVE information
- `calculate_blast_radius` - Impact analysis
- `create_patch_campaign` - Plan rollout
- `get_campaign_status` - Monitor progress
- `trigger_rollback` - Emergency rollback

### 7. Database Schema

New tables in migration `000017_add_vulnerability_response`:

```sql
-- CVE Feed Management
cve_feed_sources          -- Feed configuration
cve_cache                 -- Normalized CVE data

-- Alert Management
cve_alerts                -- Per-org alerts
cve_alert_affected_items  -- Blast radius details

-- Patch Campaigns
patch_campaigns           -- Campaign definition
patch_campaign_phases     -- Phase configuration
patch_campaign_assets     -- Per-asset tracking
patch_rollbacks           -- Rollback history

-- Compliance
vulnerability_evidence    -- Audit trail
```

### 8. API Endpoints

**CVE Alerts** (Orchestrator :8083):
```
GET  /api/v1/cve-alerts              # List alerts
GET  /api/v1/cve-alerts/summary      # Statistics
GET  /api/v1/cve-alerts/{id}         # Alert details
GET  /api/v1/cve-alerts/{id}/blast-radius
POST /api/v1/cve-alerts/{id}/investigate
POST /api/v1/cve-alerts/{id}/acknowledge
POST /api/v1/cve-alerts/{id}/resolve
```

**Patch Campaigns**:
```
GET  /api/v1/patch-campaigns
GET  /api/v1/patch-campaigns/summary
POST /api/v1/patch-campaigns
GET  /api/v1/patch-campaigns/{id}
GET  /api/v1/patch-campaigns/{id}/phases
GET  /api/v1/patch-campaigns/{id}/progress
POST /api/v1/patch-campaigns/{id}/approve
POST /api/v1/patch-campaigns/{id}/start
POST /api/v1/patch-campaigns/{id}/pause
POST /api/v1/patch-campaigns/{id}/rollback
```

## Consequences

### Positive

1. **Proactive Detection**: CVEs detected within hours of publication vs days/weeks
2. **Automated Impact Analysis**: Blast radius calculated automatically across image lineage
3. **Risk-Based Prioritization**: Urgency scoring enables focused remediation
4. **Safe Rollout**: Phased campaigns with auto-rollback prevent outages
5. **Compliance Evidence**: Automated audit trail for PCI-DSS, HIPAA, SOC 2
6. **AI-Assisted**: Vulnerability Agent can recommend and execute responses

### Negative

1. **Infrastructure Cost**: Additional service (CVE Aggregator) requires resources
2. **API Rate Limits**: NVD/OSV APIs have rate limits requiring careful polling
3. **False Positives**: Package matching may generate alerts for non-applicable CVEs
4. **Complexity**: Multi-phase rollout adds operational complexity

### Neutral

1. **Migration Required**: New database tables and Kafka topics
2. **Configuration**: Feed sources and health check thresholds need tuning
3. **Integration**: Existing Patch Agent needs coordination with Vulnerability Agent

## Implementation

### Phase 1: CVE Aggregator (2 weeks)
- CVE cache schema and models
- NVD feed integration
- OSV feed integration
- GitHub Advisories integration
- CISA KEV integration

### Phase 2: Blast Radius Engine (1 week)
- Image lineage traversal
- Asset mapping
- Urgency scoring

### Phase 3: Alert Management (1 week)
- Alert lifecycle
- Notification integration
- UI dashboard

### Phase 4: Patch Campaigns (2 weeks)
- Campaign orchestration
- Phased rollout
- Health checks
- Auto-rollback

### Phase 5: Vulnerability Agent (1 week)
- Agent implementation
- Tool registration
- Integration tests

### Phase 6: Frontend (2 weeks)
- Vulnerabilities dashboard
- Alert detail pages
- Patch campaign management
- Blast radius visualization

## Related ADRs

- ADR-007: LLM-First Orchestration (AI agent architecture)
- ADR-008: Task-Plan-Run Lifecycle (execution model)
- ADR-009: Tool Risk Taxonomy & HITL (approval workflow)
- ADR-014: Compliance Framework Integration (evidence collection)

## References

- [NIST NVD API 2.0](https://nvd.nist.gov/developers/vulnerabilities)
- [OSV Database](https://osv.dev/)
- [GitHub Advisory Database](https://github.com/advisories)
- [CISA Known Exploited Vulnerabilities](https://www.cisa.gov/known-exploited-vulnerabilities-catalog)
- [EPSS Model](https://www.first.org/epss/)
