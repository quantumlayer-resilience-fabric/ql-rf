"use client";

import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { StatusBadge } from "@/components/status/status-badge";
import {
  AlertTriangle,
  Shield,
  ExternalLink,
  CheckCircle,
  XCircle,
} from "lucide-react";
import type { Vulnerability } from "@/lib/api-sbom";

interface SBOMVulnerabilityCardProps {
  vulnerability: Vulnerability;
  packageName?: string;
}

export function SBOMVulnerabilityCard({
  vulnerability,
  packageName,
}: SBOMVulnerabilityCardProps) {
  const getSeverityIcon = () => {
    switch (vulnerability.severity) {
      case "critical":
        return <AlertTriangle className="h-5 w-5 text-status-red" />;
      case "high":
        return <AlertTriangle className="h-5 w-5 text-status-amber" />;
      case "medium":
        return <Shield className="h-5 w-5 text-status-amber" />;
      case "low":
        return <Shield className="h-5 w-5 text-muted-foreground" />;
      default:
        return <Shield className="h-5 w-5 text-muted-foreground" />;
    }
  };

  const getSeverityColor = () => {
    switch (vulnerability.severity) {
      case "critical":
        return "bg-status-red/10";
      case "high":
        return "bg-status-amber/10";
      case "medium":
        return "bg-status-amber/10";
      default:
        return "bg-muted";
    }
  };

  return (
    <div className="flex items-start gap-4 rounded-lg border p-4">
      <div className={`rounded-full p-2 ${getSeverityColor()}`}>
        {getSeverityIcon()}
      </div>
      <div className="flex-1 space-y-3">
        <div>
          <div className="flex items-center gap-2">
            <code className="rounded bg-muted px-2 py-0.5 text-sm font-medium">
              {vulnerability.cveId}
            </code>
            <StatusBadge
              status={
                vulnerability.severity === "critical" || vulnerability.severity === "high"
                  ? "critical"
                  : vulnerability.severity === "medium"
                  ? "warning"
                  : "neutral"
              }
              size="sm"
            >
              {vulnerability.severity}
            </StatusBadge>
            {vulnerability.cvssScore !== undefined && (
              <Badge variant="outline" className="text-xs">
                CVSS {vulnerability.cvssScore.toFixed(1)}
              </Badge>
            )}
            {vulnerability.exploitAvailable && (
              <Badge variant="outline" className="border-status-red/50 text-status-red text-xs">
                Exploit Available
              </Badge>
            )}
          </div>
          {packageName && (
            <div className="mt-1 text-sm text-muted-foreground">
              in {packageName}
            </div>
          )}
        </div>

        {vulnerability.description && (
          <p className="text-sm text-muted-foreground">
            {vulnerability.description}
          </p>
        )}

        <div className="flex flex-wrap items-center gap-4 text-sm">
          {vulnerability.fixedVersion ? (
            <div className="flex items-center gap-1 text-status-green">
              <CheckCircle className="h-4 w-4" />
              <span>Fix available: {vulnerability.fixedVersion}</span>
            </div>
          ) : (
            <div className="flex items-center gap-1 text-muted-foreground">
              <XCircle className="h-4 w-4" />
              <span>No fix available</span>
            </div>
          )}
          {vulnerability.publishedDate && (
            <span className="text-muted-foreground">
              Published: {new Date(vulnerability.publishedDate).toLocaleDateString()}
            </span>
          )}
          {vulnerability.dataSource && (
            <Badge variant="secondary" className="text-xs">
              {vulnerability.dataSource}
            </Badge>
          )}
        </div>

        {vulnerability.references && vulnerability.references.length > 0 && (
          <div className="space-y-1">
            <div className="text-xs font-medium text-muted-foreground">References:</div>
            <div className="flex flex-wrap gap-2">
              {vulnerability.references.slice(0, 3).map((ref, index) => (
                <Button
                  key={index}
                  variant="outline"
                  size="sm"
                  asChild
                  className="h-auto py-1 text-xs"
                >
                  <a
                    href={ref}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="flex items-center gap-1"
                  >
                    <ExternalLink className="h-3 w-3" />
                    View
                  </a>
                </Button>
              ))}
              {vulnerability.references.length > 3 && (
                <span className="text-xs text-muted-foreground">
                  +{vulnerability.references.length - 3} more
                </span>
              )}
            </div>
          </div>
        )}

        {vulnerability.cvssVector && (
          <details className="text-xs">
            <summary className="cursor-pointer text-muted-foreground hover:text-foreground">
              CVSS Vector
            </summary>
            <code className="mt-1 block rounded bg-muted p-2 text-xs">
              {vulnerability.cvssVector}
            </code>
          </details>
        )}
      </div>
    </div>
  );
}
