package models

import (
	"encoding/json"
	"time"

	"github.com/google/uuid"
)

// =============================================================================
// Vulnerability Evidence
// =============================================================================

// VulnerabilityEvidence represents an audit trail entry for compliance.
type VulnerabilityEvidence struct {
	ID                 uuid.UUID        `json:"id" db:"id"`
	OrgID              uuid.UUID        `json:"orgId" db:"org_id"`
	EventType          string           `json:"eventType" db:"event_type"`
	CVEID              *string          `json:"cveId,omitempty" db:"cve_id"`
	AlertID            *uuid.UUID       `json:"alertId,omitempty" db:"alert_id"`
	CampaignID         *uuid.UUID       `json:"campaignId,omitempty" db:"campaign_id"`
	AssetID            *uuid.UUID       `json:"assetId,omitempty" db:"asset_id"`
	EventData          json.RawMessage  `json:"eventData" db:"event_data"`
	ActorType          string           `json:"actorType" db:"actor_type"`                    // system, user, automation, ai_agent
	ActorID            *string          `json:"actorId,omitempty" db:"actor_id"`
	ActorName          *string          `json:"actorName,omitempty" db:"actor_name"`
	ComplianceControls json.RawMessage  `json:"complianceControls,omitempty" db:"compliance_controls"`
	EventAt            time.Time        `json:"eventAt" db:"event_at"`
	CreatedAt          time.Time        `json:"createdAt" db:"created_at"`
}

// VulnerabilityEvidenceEventType constants.
type VulnerabilityEvidenceEventType string

const (
	// Detection events
	EvidenceEventCVEDetected            VulnerabilityEvidenceEventType = "cve_detected"
	EvidenceEventCVEEnriched            VulnerabilityEvidenceEventType = "cve_enriched"
	EvidenceEventBlastRadiusCalculated  VulnerabilityEvidenceEventType = "blast_radius_calculated"

	// Alert lifecycle
	EvidenceEventAlertCreated       VulnerabilityEvidenceEventType = "alert_created"
	EvidenceEventAlertAssigned      VulnerabilityEvidenceEventType = "alert_assigned"
	EvidenceEventAlertAcknowledged  VulnerabilityEvidenceEventType = "alert_acknowledged"
	EvidenceEventAlertEscalated     VulnerabilityEvidenceEventType = "alert_escalated"
	EvidenceEventAlertResolved      VulnerabilityEvidenceEventType = "alert_resolved"
	EvidenceEventAlertDismissed     VulnerabilityEvidenceEventType = "alert_dismissed"

	// Campaign lifecycle
	EvidenceEventCampaignCreated        VulnerabilityEvidenceEventType = "campaign_created"
	EvidenceEventCampaignApproved       VulnerabilityEvidenceEventType = "campaign_approved"
	EvidenceEventCampaignStarted        VulnerabilityEvidenceEventType = "campaign_started"
	EvidenceEventCampaignPhaseStarted   VulnerabilityEvidenceEventType = "campaign_phase_started"
	EvidenceEventCampaignPhaseCompleted VulnerabilityEvidenceEventType = "campaign_phase_completed"
	EvidenceEventCampaignCompleted      VulnerabilityEvidenceEventType = "campaign_completed"
	EvidenceEventCampaignFailed         VulnerabilityEvidenceEventType = "campaign_failed"

	// Remediation events
	EvidenceEventPatchStarted      VulnerabilityEvidenceEventType = "patch_started"
	EvidenceEventPatchCompleted    VulnerabilityEvidenceEventType = "patch_completed"
	EvidenceEventPatchFailed       VulnerabilityEvidenceEventType = "patch_failed"
	EvidenceEventRollbackTriggered VulnerabilityEvidenceEventType = "rollback_triggered"
	EvidenceEventRollbackCompleted VulnerabilityEvidenceEventType = "rollback_completed"

	// Health check events
	EvidenceEventHealthCheckStarted VulnerabilityEvidenceEventType = "health_check_started"
	EvidenceEventHealthCheckPassed  VulnerabilityEvidenceEventType = "health_check_passed"
	EvidenceEventHealthCheckFailed  VulnerabilityEvidenceEventType = "health_check_failed"

	// SLA events
	EvidenceEventSLAWarning  VulnerabilityEvidenceEventType = "sla_warning"
	EvidenceEventSLABreached VulnerabilityEvidenceEventType = "sla_breached"
)

// EvidenceActorType constants.
type EvidenceActorType string

const (
	EvidenceActorSystem     EvidenceActorType = "system"
	EvidenceActorUser       EvidenceActorType = "user"
	EvidenceActorAutomation EvidenceActorType = "automation"
	EvidenceActorAIAgent    EvidenceActorType = "ai_agent"
)

// =============================================================================
// Compliance Control Mapping (for Evidence)
// =============================================================================

// EvidenceComplianceControl represents a compliance control mapping for evidence.
// This is separate from ComplianceControl (which is a DB entity in compliance.go).
type EvidenceComplianceControl struct {
	Framework    string `json:"framework"`    // SOC2, PCI-DSS, HIPAA, FedRAMP, ISO27001
	ControlID    string `json:"controlId"`    // CC7.1, 6.2, etc.
	ControlName  string `json:"controlName"`
	Description  string `json:"description,omitempty"`
}

// EvidenceComplianceFrameworkName constants for evidence control mapping.
type EvidenceComplianceFrameworkName string

const (
	EvidenceFrameworkSOC2      EvidenceComplianceFrameworkName = "SOC2"
	EvidenceFrameworkPCIDSS    EvidenceComplianceFrameworkName = "PCI-DSS"
	EvidenceFrameworkHIPAA     EvidenceComplianceFrameworkName = "HIPAA"
	EvidenceFrameworkFedRAMP   EvidenceComplianceFrameworkName = "FedRAMP"
	EvidenceFrameworkISO27001  EvidenceComplianceFrameworkName = "ISO27001"
	EvidenceFrameworkNIST      EvidenceComplianceFrameworkName = "NIST-CSF"
	EvidenceFrameworkCISv8     EvidenceComplianceFrameworkName = "CIS-v8"
)

// GetEvidenceComplianceControlsForEvent returns the compliance controls relevant to an event type.
func GetEvidenceComplianceControlsForEvent(eventType VulnerabilityEvidenceEventType) []EvidenceComplianceControl {
	controls := []EvidenceComplianceControl{}

	switch eventType {
	case EvidenceEventCVEDetected, EvidenceEventCVEEnriched:
		controls = append(controls,
			EvidenceComplianceControl{Framework: "SOC2", ControlID: "CC7.1", ControlName: "Vulnerability Detection", Description: "Detection of security events"},
			EvidenceComplianceControl{Framework: "PCI-DSS", ControlID: "6.1", ControlName: "Vulnerability Identification", Description: "Identify security vulnerabilities"},
			EvidenceComplianceControl{Framework: "HIPAA", ControlID: "164.308(a)(5)", ControlName: "Security Awareness", Description: "Protection from malicious software"},
			EvidenceComplianceControl{Framework: "NIST-CSF", ControlID: "ID.RA-1", ControlName: "Asset Vulnerabilities", Description: "Asset vulnerabilities identified"},
		)

	case EvidenceEventAlertCreated, EvidenceEventAlertAssigned:
		controls = append(controls,
			EvidenceComplianceControl{Framework: "SOC2", ControlID: "CC7.2", ControlName: "Anomaly Detection", Description: "Monitoring for security events"},
			EvidenceComplianceControl{Framework: "PCI-DSS", ControlID: "12.10.1", ControlName: "Incident Response", Description: "Create incident response plan"},
			EvidenceComplianceControl{Framework: "ISO27001", ControlID: "A.16.1.1", ControlName: "Responsibilities", Description: "Incident management responsibilities"},
		)

	case EvidenceEventCampaignApproved:
		controls = append(controls,
			EvidenceComplianceControl{Framework: "SOC2", ControlID: "CC6.1", ControlName: "Change Management", Description: "Authorized changes"},
			EvidenceComplianceControl{Framework: "PCI-DSS", ControlID: "6.4.5", ControlName: "Change Control", Description: "Change control procedures"},
			EvidenceComplianceControl{Framework: "FedRAMP", ControlID: "CM-3", ControlName: "Configuration Change Control", Description: "Configuration change control"},
		)

	case EvidenceEventPatchStarted, EvidenceEventPatchCompleted:
		controls = append(controls,
			EvidenceComplianceControl{Framework: "SOC2", ControlID: "CC6.8", ControlName: "Software Updates", Description: "System software is updated"},
			EvidenceComplianceControl{Framework: "PCI-DSS", ControlID: "6.2", ControlName: "Security Patches", Description: "Install applicable security patches"},
			EvidenceComplianceControl{Framework: "HIPAA", ControlID: "164.308(a)(1)(ii)(B)", ControlName: "Risk Management", Description: "Implement security measures"},
			EvidenceComplianceControl{Framework: "FedRAMP", ControlID: "SI-2", ControlName: "Flaw Remediation", Description: "Identify, report, correct flaws"},
			EvidenceComplianceControl{Framework: "CIS-v8", ControlID: "7.3", ControlName: "Automated Patch Management", Description: "Use automated patch management"},
		)

	case EvidenceEventRollbackTriggered, EvidenceEventRollbackCompleted:
		controls = append(controls,
			EvidenceComplianceControl{Framework: "SOC2", ControlID: "CC7.4", ControlName: "Incident Response", Description: "Response to incidents"},
			EvidenceComplianceControl{Framework: "PCI-DSS", ControlID: "12.10.2", ControlName: "Incident Response", Description: "Review and test incident response plan"},
			EvidenceComplianceControl{Framework: "FedRAMP", ControlID: "CP-10", ControlName: "System Recovery", Description: "System recovery and reconstitution"},
		)

	case EvidenceEventHealthCheckPassed, EvidenceEventHealthCheckFailed:
		controls = append(controls,
			EvidenceComplianceControl{Framework: "SOC2", ControlID: "CC7.3", ControlName: "Change Monitoring", Description: "Evaluate and monitor changes"},
			EvidenceComplianceControl{Framework: "PCI-DSS", ControlID: "11.2", ControlName: "Vulnerability Scans", Description: "Run vulnerability scans"},
			EvidenceComplianceControl{Framework: "ISO27001", ControlID: "A.12.6.1", ControlName: "Vulnerability Management", Description: "Technical vulnerability management"},
		)

	case EvidenceEventAlertResolved:
		controls = append(controls,
			EvidenceComplianceControl{Framework: "SOC2", ControlID: "CC7.5", ControlName: "Incident Recovery", Description: "Recovery from incidents"},
			EvidenceComplianceControl{Framework: "PCI-DSS", ControlID: "12.10.6", ControlName: "Lessons Learned", Description: "Modify incident response plan based on lessons learned"},
			EvidenceComplianceControl{Framework: "HIPAA", ControlID: "164.308(a)(6)(ii)", ControlName: "Response and Reporting", Description: "Identify and respond to incidents"},
		)

	case EvidenceEventSLABreached:
		controls = append(controls,
			EvidenceComplianceControl{Framework: "SOC2", ControlID: "CC2.3", ControlName: "Communication", Description: "Internal communication on matters affecting functioning"},
			EvidenceComplianceControl{Framework: "PCI-DSS", ControlID: "12.1", ControlName: "Security Policy", Description: "Establish and publish security policy"},
		)
	}

	return controls
}

// =============================================================================
// Evidence API Types
// =============================================================================

// VulnerabilityEvidenceFilter represents filters for listing evidence.
type VulnerabilityEvidenceFilter struct {
	EventType   string     `json:"eventType,omitempty"`
	CVEID       string     `json:"cveId,omitempty"`
	AlertID     *uuid.UUID `json:"alertId,omitempty"`
	CampaignID  *uuid.UUID `json:"campaignId,omitempty"`
	AssetID     *uuid.UUID `json:"assetId,omitempty"`
	ActorType   string     `json:"actorType,omitempty"`
	Framework   string     `json:"framework,omitempty"` // Filter by compliance framework
	StartTime   *time.Time `json:"startTime,omitempty"`
	EndTime     *time.Time `json:"endTime,omitempty"`
}

// VulnerabilityEvidenceListResponse represents a paginated list of evidence.
type VulnerabilityEvidenceListResponse struct {
	Evidence   []VulnerabilityEvidence `json:"evidence"`
	Total      int                     `json:"total"`
	Page       int                     `json:"page"`
	PageSize   int                     `json:"pageSize"`
	TotalPages int                     `json:"totalPages"`
}

// CreateEvidenceRequest represents a request to create an evidence entry.
type CreateEvidenceRequest struct {
	EventType          string                 `json:"eventType" validate:"required"`
	CVEID              *string                `json:"cveId,omitempty"`
	AlertID            *uuid.UUID             `json:"alertId,omitempty"`
	CampaignID         *uuid.UUID             `json:"campaignId,omitempty"`
	AssetID            *uuid.UUID             `json:"assetId,omitempty"`
	EventData          map[string]interface{} `json:"eventData"`
	ActorType          string                 `json:"actorType" validate:"required,oneof=system user automation ai_agent"`
	ActorID            *string                `json:"actorId,omitempty"`
	ActorName          *string                `json:"actorName,omitempty"`
}

// =============================================================================
// Report Types
// =============================================================================

// VulnerabilityReport represents a compliance report.
type VulnerabilityReport struct {
	ID              uuid.UUID                    `json:"id"`
	OrgID           uuid.UUID                    `json:"orgId"`
	ReportType      string                       `json:"reportType"`      // compliance, audit, executive
	Framework       *string                      `json:"framework,omitempty"` // SOC2, PCI-DSS, etc.
	Title           string                       `json:"title"`
	GeneratedAt     time.Time                    `json:"generatedAt"`
	StartDate       time.Time                    `json:"startDate"`
	EndDate         time.Time                    `json:"endDate"`
	Summary         VulnerabilityReportSummary   `json:"summary"`
	AlertsSummary   CVEAlertSummary              `json:"alertsSummary"`
	CampaignsSummary PatchCampaignSummary        `json:"campaignsSummary"`
	Timeline        []VulnerabilityTimelineEntry        `json:"timeline"`
	ControlsMet     []EvidenceComplianceControlStatus   `json:"controlsMet"`
}

// VulnerabilityReportSummary represents high-level report statistics.
type VulnerabilityReportSummary struct {
	TotalCVEsDetected          int     `json:"totalCvesDetected"`
	TotalCVEsRemediated        int     `json:"totalCvesRemediated"`
	AverageRemediationTimeDays float64 `json:"averageRemediationTimeDays"`
	SLAComplianceRate          float64 `json:"slaComplianceRate"`
	TotalAssetsScanned         int     `json:"totalAssetsScanned"`
	TotalAssetsPatched         int     `json:"totalAssetsPatched"`
	CriticalCVEsRemediatedIn24h int    `json:"criticalCvesRemediatedIn24h"`
	RollbackCount              int     `json:"rollbackCount"`
	AutomatedRemediationRate   float64 `json:"automatedRemediationRate"`
}

// VulnerabilityTimelineEntry represents an entry in the report timeline.
type VulnerabilityTimelineEntry struct {
	Timestamp   time.Time `json:"timestamp"`
	EventType   string    `json:"eventType"`
	Description string    `json:"description"`
	CVEID       *string   `json:"cveId,omitempty"`
	Severity    *string   `json:"severity,omitempty"`
	AssetCount  *int      `json:"assetCount,omitempty"`
}

// EvidenceComplianceControlStatus represents the status of a compliance control for reports.
type EvidenceComplianceControlStatus struct {
	Control       EvidenceComplianceControl `json:"control"`
	Status        string                    `json:"status"` // met, partially_met, not_met
	EvidenceCount int                       `json:"evidenceCount"`
	LastEvidence  *time.Time                `json:"lastEvidence,omitempty"`
	Notes         string                    `json:"notes,omitempty"`
}

// GenerateReportRequest represents a request to generate a report.
type GenerateReportRequest struct {
	ReportType  string     `json:"reportType" validate:"required,oneof=compliance audit executive"`
	Framework   *string    `json:"framework,omitempty"`
	StartDate   time.Time  `json:"startDate" validate:"required"`
	EndDate     time.Time  `json:"endDate" validate:"required"`
	IncludeDetails bool    `json:"includeDetails"`
}
