openapi: 3.0.3
info:
  title: QL-RF API
  description: |
    QuantumLayer Resilience Fabric API - Infrastructure resilience platform
    providing golden image management, drift detection, compliance, and DR capabilities.
  version: 1.0.0
  contact:
    name: QL-RF Team
    email: support@quantumlayer.com

servers:
  - url: http://localhost:8080/api/v1
    description: Local development
  - url: https://api.ql-rf.example.com/api/v1
    description: Production

tags:
  - name: Assets
    description: Asset management
  - name: Images
    description: Golden image management
  - name: Sites
    description: Site management
  - name: Drift
    description: Drift detection and remediation
  - name: Compliance
    description: Compliance frameworks and assessments
  - name: Risk
    description: Risk scoring and predictions
  - name: RBAC
    description: Role-based access control
  - name: Organization
    description: Organization and multi-tenancy management
  - name: SBOM
    description: Software Bill of Materials management
  - name: InSpec
    description: Chef InSpec compliance scanning

paths:
  # ============================================================================
  # RBAC Endpoints
  # ============================================================================
  /rbac/roles:
    get:
      summary: List roles
      description: List all roles available to the organization (including system roles)
      tags: [RBAC]
      responses:
        '200':
          description: List of roles
          content:
            application/json:
              schema:
                type: object
                properties:
                  roles:
                    type: array
                    items:
                      $ref: '#/components/schemas/Role'

  /rbac/roles/{roleId}:
    get:
      summary: Get role details
      tags: [RBAC]
      parameters:
        - $ref: '#/components/parameters/roleId'
      responses:
        '200':
          description: Role details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
        '404':
          $ref: '#/components/responses/NotFound'

  /rbac/permissions:
    get:
      summary: List all permissions
      description: List all available permissions in the system
      tags: [RBAC]
      responses:
        '200':
          description: List of permissions
          content:
            application/json:
              schema:
                type: object
                properties:
                  permissions:
                    type: array
                    items:
                      $ref: '#/components/schemas/Permission'

  /rbac/users/{userId}/roles:
    get:
      summary: Get user roles
      description: List roles assigned to a user
      tags: [RBAC]
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: User roles
          content:
            application/json:
              schema:
                type: object
                properties:
                  roles:
                    type: array
                    items:
                      $ref: '#/components/schemas/Role'

    post:
      summary: Assign role to user
      description: Assign a role to a user
      tags: [RBAC]
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [role_id]
              properties:
                role_id:
                  type: string
                  format: uuid
                expires_at:
                  type: string
                  format: date-time
      responses:
        '200':
          description: Role assigned
        '400':
          $ref: '#/components/responses/BadRequest'

  /rbac/users/{userId}/roles/{roleId}:
    delete:
      summary: Revoke role from user
      tags: [RBAC]
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/roleId'
      responses:
        '200':
          description: Role revoked
        '404':
          $ref: '#/components/responses/NotFound'

  /rbac/users/{userId}/permissions:
    get:
      summary: Get user permissions
      description: Get all effective permissions for a user
      tags: [RBAC]
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: User permissions
          content:
            application/json:
              schema:
                type: object
                properties:
                  permissions:
                    type: array
                    items:
                      $ref: '#/components/schemas/UserPermission'

  /rbac/check:
    post:
      summary: Check permission
      description: Check if a user has a specific permission
      tags: [RBAC]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [user_id, resource_type, action]
              properties:
                user_id:
                  type: string
                resource_type:
                  type: string
                resource_id:
                  type: string
                  format: uuid
                action:
                  type: string
      responses:
        '200':
          description: Permission check result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PermissionCheck'

  /rbac/teams:
    get:
      summary: List teams
      tags: [RBAC]
      responses:
        '200':
          description: List of teams
          content:
            application/json:
              schema:
                type: object
                properties:
                  teams:
                    type: array
                    items:
                      $ref: '#/components/schemas/Team'

    post:
      summary: Create team
      tags: [RBAC]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                description:
                  type: string
      responses:
        '201':
          description: Team created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Team'

  /rbac/teams/{teamId}/members:
    get:
      summary: List team members
      tags: [RBAC]
      parameters:
        - name: teamId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Team members
          content:
            application/json:
              schema:
                type: object
                properties:
                  members:
                    type: array
                    items:
                      $ref: '#/components/schemas/TeamMember'

    post:
      summary: Add team member
      tags: [RBAC]
      parameters:
        - name: teamId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [user_id]
              properties:
                user_id:
                  type: string
                role:
                  type: string
                  enum: [member, admin]
                  default: member
      responses:
        '200':
          description: Member added

  # ============================================================================
  # Organization / Multi-tenancy Endpoints
  # ============================================================================
  /organization/quota:
    get:
      summary: Get organization quota
      description: Get the quota limits for the current organization
      tags: [Organization]
      responses:
        '200':
          description: Organization quota
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrganizationQuota'

  /organization/usage:
    get:
      summary: Get organization usage
      description: Get current resource usage for the organization
      tags: [Organization]
      responses:
        '200':
          description: Organization usage
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrganizationUsage'

  /organization/quota-status:
    get:
      summary: Get quota status
      description: Get detailed quota status with remaining allocations
      tags: [Organization]
      responses:
        '200':
          description: Quota status
          content:
            application/json:
              schema:
                type: object
                properties:
                  statuses:
                    type: array
                    items:
                      $ref: '#/components/schemas/QuotaStatus'

  /organization/subscription:
    get:
      summary: Get subscription
      description: Get the current subscription for the organization
      tags: [Organization]
      responses:
        '200':
          description: Subscription details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subscription'

  /organization/plans:
    get:
      summary: List available plans
      description: List all available subscription plans
      tags: [Organization]
      responses:
        '200':
          description: Available plans
          content:
            application/json:
              schema:
                type: object
                properties:
                  plans:
                    type: array
                    items:
                      $ref: '#/components/schemas/SubscriptionPlan'

  /organizations:
    post:
      summary: Create organization
      description: Create a new organization with quota and subscription
      tags: [Organization]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrganizationRequest'
      responses:
        '201':
          description: Organization created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateOrganizationResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /organization:
    get:
      summary: Get current organization
      description: Get the current organization context for the authenticated user
      tags: [Organization]
      responses:
        '200':
          description: Organization details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /organization/check:
    get:
      summary: Check user organization
      description: Check if the current user has an organization
      tags: [Organization]
      responses:
        '200':
          description: Organization check result
          content:
            application/json:
              schema:
                type: object
                properties:
                  has_organization:
                    type: boolean
                  organization:
                    $ref: '#/components/schemas/Organization'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /organization/seed-demo:
    post:
      summary: Seed demo data
      description: Seed demo data (sites, assets, images) for the organization
      tags: [Organization]
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SeedDemoDataRequest'
      responses:
        '200':
          description: Demo data seeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SeedDemoDataResult'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  # ============================================================================
  # Enhanced Compliance Endpoints
  # ============================================================================
  /compliance/frameworks:
    get:
      summary: List compliance frameworks
      description: List all available compliance frameworks (CIS, SOC2, NIST, etc.)
      tags: [Compliance]
      responses:
        '200':
          description: List of frameworks
          content:
            application/json:
              schema:
                type: object
                properties:
                  frameworks:
                    type: array
                    items:
                      $ref: '#/components/schemas/ComplianceFramework'

  /compliance/frameworks/{frameworkId}/controls:
    get:
      summary: List framework controls
      description: List all controls for a specific framework
      tags: [Compliance]
      parameters:
        - name: frameworkId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of controls
          content:
            application/json:
              schema:
                type: object
                properties:
                  controls:
                    type: array
                    items:
                      $ref: '#/components/schemas/ComplianceControl'

  /compliance/controls/{controlId}/mappings:
    get:
      summary: Get control mappings
      description: Get cross-framework mappings for a control
      tags: [Compliance]
      parameters:
        - name: controlId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Mapped controls from other frameworks
          content:
            application/json:
              schema:
                type: object
                properties:
                  mappings:
                    type: array
                    items:
                      $ref: '#/components/schemas/ComplianceControl'

  /compliance/assessments:
    get:
      summary: List assessments
      description: List compliance assessments
      tags: [Compliance]
      parameters:
        - name: framework_id
          in: query
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: List of assessments
          content:
            application/json:
              schema:
                type: object
                properties:
                  assessments:
                    type: array
                    items:
                      $ref: '#/components/schemas/ComplianceAssessment'

    post:
      summary: Create assessment
      description: Start a new compliance assessment
      tags: [Compliance]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [framework_id, name]
              properties:
                framework_id:
                  type: string
                  format: uuid
                name:
                  type: string
                description:
                  type: string
                assessment_type:
                  type: string
                  enum: [automated, manual, hybrid]
                  default: automated
                scope_sites:
                  type: array
                  items:
                    type: string
                    format: uuid
                scope_assets:
                  type: array
                  items:
                    type: string
                    format: uuid
      responses:
        '201':
          description: Assessment created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ComplianceAssessment'

  /compliance/assessments/{assessmentId}:
    get:
      summary: Get assessment
      description: Get assessment details and results
      tags: [Compliance]
      parameters:
        - name: assessmentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Assessment details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ComplianceAssessment'

  /compliance/evidence:
    get:
      summary: List evidence
      description: List compliance evidence
      tags: [Compliance]
      parameters:
        - name: control_id
          in: query
          schema:
            type: string
            format: uuid
        - name: current_only
          in: query
          schema:
            type: boolean
            default: true
      responses:
        '200':
          description: List of evidence
          content:
            application/json:
              schema:
                type: object
                properties:
                  evidence:
                    type: array
                    items:
                      $ref: '#/components/schemas/ComplianceEvidence'

    post:
      summary: Upload evidence
      description: Upload compliance evidence for a control
      tags: [Compliance]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [control_id, evidence_type, title, storage_type]
              properties:
                control_id:
                  type: string
                  format: uuid
                evidence_type:
                  type: string
                  enum: [screenshot, log, config, report, attestation]
                title:
                  type: string
                description:
                  type: string
                storage_type:
                  type: string
                storage_path:
                  type: string
                valid_until:
                  type: string
                  format: date-time
      responses:
        '201':
          description: Evidence uploaded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ComplianceEvidence'

  /compliance/exemptions:
    get:
      summary: List exemptions
      description: List active compliance exemptions
      tags: [Compliance]
      responses:
        '200':
          description: List of exemptions
          content:
            application/json:
              schema:
                type: object
                properties:
                  exemptions:
                    type: array
                    items:
                      $ref: '#/components/schemas/ComplianceExemption'

    post:
      summary: Create exemption
      description: Request a compliance exemption
      tags: [Compliance]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [control_id, reason, expires_at]
              properties:
                control_id:
                  type: string
                  format: uuid
                asset_id:
                  type: string
                  format: uuid
                site_id:
                  type: string
                  format: uuid
                reason:
                  type: string
                risk_acceptance:
                  type: string
                compensating_controls:
                  type: string
                expires_at:
                  type: string
                  format: date-time
      responses:
        '201':
          description: Exemption created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ComplianceExemption'

  /compliance/score:
    get:
      summary: Get compliance score
      description: Get overall compliance score
      tags: [Compliance]
      parameters:
        - name: framework_id
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Compliance score
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ComplianceScore'

  # ============================================================================
  # SBOM Endpoints
  # ============================================================================
  /sbom:
    get:
      summary: List all SBOMs
      description: Get a list of all Software Bill of Materials for the organization
      tags: [SBOM]
      parameters:
        - name: image_id
          in: query
          description: Filter by image ID
          schema:
            type: string
            format: uuid
        - name: format
          in: query
          description: SBOM format
          schema:
            type: string
            enum: [spdx, cyclonedx]
      responses:
        '200':
          description: List of SBOMs
          content:
            application/json:
              schema:
                type: object
                properties:
                  sboms:
                    type: array
                    items:
                      $ref: '#/components/schemas/SBOM'
                  total:
                    type: integer

    post:
      summary: Generate SBOM
      description: Generate a new SBOM for an image
      tags: [SBOM]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [image_id]
              properties:
                image_id:
                  type: string
                  format: uuid
                format:
                  type: string
                  enum: [spdx, cyclonedx]
                  default: spdx
      responses:
        '201':
          description: SBOM generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SBOM'
        '400':
          $ref: '#/components/responses/BadRequest'

  /sbom/{sbomId}:
    get:
      summary: Get SBOM details
      description: Get detailed SBOM information including components
      tags: [SBOM]
      parameters:
        - name: sbomId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: SBOM details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SBOMDetail'
        '404':
          $ref: '#/components/responses/NotFound'

  /sbom/{sbomId}/packages:
    get:
      summary: List SBOM packages
      description: Get all packages/components in an SBOM
      tags: [SBOM]
      parameters:
        - name: sbomId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of packages
          content:
            application/json:
              schema:
                type: object
                properties:
                  packages:
                    type: array
                    items:
                      $ref: '#/components/schemas/SBOMPackage'
                  total:
                    type: integer

  /sbom/{sbomId}/vulnerabilities:
    get:
      summary: List SBOM vulnerabilities
      description: Get vulnerabilities found in SBOM components
      tags: [SBOM]
      parameters:
        - name: sbomId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: severity
          in: query
          description: Filter by severity
          schema:
            type: string
            enum: [critical, high, medium, low]
      responses:
        '200':
          description: List of vulnerabilities
          content:
            application/json:
              schema:
                type: object
                properties:
                  vulnerabilities:
                    type: array
                    items:
                      $ref: '#/components/schemas/SBOMVulnerability'
                  total:
                    type: integer
                  by_severity:
                    type: object
                    additionalProperties:
                      type: integer

  /sbom/licenses:
    get:
      summary: Get license summary
      description: Get aggregated license information across all SBOMs
      tags: [SBOM]
      responses:
        '200':
          description: License summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LicenseSummary'

  /sbom/{sbomId}/export:
    get:
      summary: Export SBOM
      description: Download SBOM in specified format
      tags: [SBOM]
      parameters:
        - name: sbomId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: format
          in: query
          description: Export format
          schema:
            type: string
            enum: [spdx-json, spdx-tag-value, cyclonedx-json, cyclonedx-xml]
            default: spdx-json
      responses:
        '200':
          description: SBOM file
          content:
            application/json:
              schema:
                type: object
            application/xml:
              schema:
                type: string
        '404':
          $ref: '#/components/responses/NotFound'

  # ============================================================================
  # InSpec Endpoints
  # ============================================================================
  /inspec/profiles:
    get:
      summary: List InSpec profiles
      description: Get all available InSpec compliance profiles
      tags: [InSpec]
      parameters:
        - name: framework
          in: query
          description: Filter by compliance framework
          schema:
            type: string
            enum: [cis, stig, hipaa, pci-dss, soc2]
        - name: platform
          in: query
          description: Filter by target platform
          schema:
            type: string
            enum: [linux, windows, docker, kubernetes]
      responses:
        '200':
          description: List of profiles
          content:
            application/json:
              schema:
                type: object
                properties:
                  profiles:
                    type: array
                    items:
                      $ref: '#/components/schemas/InSpecProfile'
                  total:
                    type: integer

    post:
      summary: Create InSpec profile
      description: Create a custom InSpec profile
      tags: [InSpec]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateInSpecProfile'
      responses:
        '201':
          description: Profile created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InSpecProfile'
        '400':
          $ref: '#/components/responses/BadRequest'

  /inspec/profiles/{profileId}:
    get:
      summary: Get InSpec profile details
      description: Get detailed information about an InSpec profile
      tags: [InSpec]
      parameters:
        - name: profileId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Profile details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InSpecProfileDetail'
        '404':
          $ref: '#/components/responses/NotFound'

  /inspec/runs:
    get:
      summary: List InSpec scan runs
      description: Get all InSpec compliance scan runs
      tags: [InSpec]
      parameters:
        - name: profile_id
          in: query
          description: Filter by profile
          schema:
            type: string
            format: uuid
        - name: asset_id
          in: query
          description: Filter by asset
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          description: Filter by status
          schema:
            type: string
            enum: [pending, running, completed, failed]
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: List of scan runs
          content:
            application/json:
              schema:
                type: object
                properties:
                  runs:
                    type: array
                    items:
                      $ref: '#/components/schemas/InSpecRun'
                  total:
                    type: integer

    post:
      summary: Execute InSpec scan
      description: Run an InSpec compliance scan against target assets
      tags: [InSpec]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [profile_id, target_assets]
              properties:
                profile_id:
                  type: string
                  format: uuid
                target_assets:
                  type: array
                  items:
                    type: string
                    format: uuid
                  minItems: 1
      responses:
        '202':
          description: Scan initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InSpecRun'
        '400':
          $ref: '#/components/responses/BadRequest'

  /inspec/runs/{runId}:
    get:
      summary: Get InSpec run details
      description: Get detailed results of an InSpec scan run
      tags: [InSpec]
      parameters:
        - name: runId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Run details with results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InSpecRunDetail'
        '404':
          $ref: '#/components/responses/NotFound'

  /inspec/runs/{runId}/controls:
    get:
      summary: Get control results
      description: Get individual control results from an InSpec run
      tags: [InSpec]
      parameters:
        - name: runId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          description: Filter by status
          schema:
            type: string
            enum: [passed, failed, skipped]
      responses:
        '200':
          description: Control results
          content:
            application/json:
              schema:
                type: object
                properties:
                  controls:
                    type: array
                    items:
                      $ref: '#/components/schemas/InSpecControlResult'
                  total:
                    type: integer

  /inspec/schedules:
    get:
      summary: List scan schedules
      description: Get all configured InSpec scan schedules
      tags: [InSpec]
      responses:
        '200':
          description: List of schedules
          content:
            application/json:
              schema:
                type: object
                properties:
                  schedules:
                    type: array
                    items:
                      $ref: '#/components/schemas/InSpecSchedule'
                  total:
                    type: integer

    post:
      summary: Create scan schedule
      description: Create a new InSpec scan schedule
      tags: [InSpec]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateInSpecSchedule'
      responses:
        '201':
          description: Schedule created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InSpecSchedule'
        '400':
          $ref: '#/components/responses/BadRequest'

  /inspec/schedules/{scheduleId}:
    get:
      summary: Get schedule details
      tags: [InSpec]
      parameters:
        - name: scheduleId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Schedule details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InSpecSchedule'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      summary: Update schedule
      tags: [InSpec]
      parameters:
        - name: scheduleId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateInSpecSchedule'
      responses:
        '200':
          description: Schedule updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InSpecSchedule'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      summary: Delete schedule
      tags: [InSpec]
      parameters:
        - name: scheduleId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Schedule deleted
        '404':
          $ref: '#/components/responses/NotFound'

components:
  parameters:
    roleId:
      name: roleId
      in: path
      required: true
      schema:
        type: string
        format: uuid

  schemas:
    # RBAC Schemas
    Role:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        display_name:
          type: string
        description:
          type: string
        org_id:
          type: string
          format: uuid
        is_system_role:
          type: boolean
        parent_role_id:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Permission:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        resource_type:
          type: string
        action:
          type: string
          enum: [read, write, delete, execute, approve, admin]
        description:
          type: string
        is_system:
          type: boolean

    UserPermission:
      type: object
      properties:
        permission_name:
          type: string
        resource_type:
          type: string
        action:
          type: string
        source:
          type: string
          enum: [role, direct, team]

    PermissionCheck:
      type: object
      properties:
        allowed:
          type: boolean
        source:
          type: string
        reason:
          type: string

    Team:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        created_by:
          type: string
        created_at:
          type: string
          format: date-time

    TeamMember:
      type: object
      properties:
        id:
          type: string
          format: uuid
        team_id:
          type: string
          format: uuid
        user_id:
          type: string
        role:
          type: string
          enum: [member, admin]
        added_at:
          type: string
          format: date-time

    # Multi-tenancy Schemas
    OrganizationQuota:
      type: object
      properties:
        org_id:
          type: string
          format: uuid
        max_assets:
          type: integer
        max_images:
          type: integer
        max_sites:
          type: integer
        max_users:
          type: integer
        max_teams:
          type: integer
        max_ai_tasks_per_day:
          type: integer
        max_ai_tokens_per_month:
          type: integer
        max_storage_bytes:
          type: integer
        api_rate_limit_per_minute:
          type: integer
        dr_enabled:
          type: boolean
        compliance_enabled:
          type: boolean
        advanced_analytics_enabled:
          type: boolean

    OrganizationUsage:
      type: object
      properties:
        org_id:
          type: string
          format: uuid
        asset_count:
          type: integer
        image_count:
          type: integer
        site_count:
          type: integer
        user_count:
          type: integer
        team_count:
          type: integer
        storage_used_bytes:
          type: integer
        ai_tasks_today:
          type: integer
        ai_tokens_this_month:
          type: integer
        api_requests_today:
          type: integer

    QuotaStatus:
      type: object
      properties:
        resource_type:
          type: string
        limit:
          type: integer
        used:
          type: integer
        remaining:
          type: integer
        percentage_used:
          type: number
        is_exceeded:
          type: boolean

    SubscriptionPlan:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        display_name:
          type: string
        description:
          type: string
        plan_type:
          type: string
          enum: [free, starter, professional, enterprise]
        default_max_assets:
          type: integer
        default_max_images:
          type: integer
        default_max_sites:
          type: integer
        default_max_users:
          type: integer
        default_max_ai_tasks:
          type: integer
        default_max_ai_tokens:
          type: integer
        default_max_storage:
          type: integer
        monthly_price_usd:
          type: number
        annual_price_usd:
          type: number
        dr_included:
          type: boolean
        compliance_included:
          type: boolean
        advanced_analytics:
          type: boolean
        custom_integrations:
          type: boolean
        is_active:
          type: boolean

    Organization:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        slug:
          type: string
        status:
          type: string
          enum: [active, suspended, deleted]
        settings:
          type: object
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateOrganizationRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 100
        slug:
          type: string
        plan_id:
          type: string
          description: Plan name (free, starter, professional, enterprise). Defaults to free.

    CreateOrganizationResult:
      type: object
      properties:
        organization:
          $ref: '#/components/schemas/Organization'
        quota:
          $ref: '#/components/schemas/OrganizationQuota'
        subscription:
          $ref: '#/components/schemas/Subscription'

    SeedDemoDataRequest:
      type: object
      properties:
        platform:
          type: string
          enum: [aws, azure, gcp]
          default: aws
          description: Cloud platform to seed demo data for

    SeedDemoDataResult:
      type: object
      properties:
        sites_created:
          type: integer
        assets_created:
          type: integer
        images_created:
          type: integer

    Subscription:
      type: object
      properties:
        id:
          type: string
          format: uuid
        org_id:
          type: string
          format: uuid
        plan_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [active, cancelled, suspended, trial]
        trial_ends_at:
          type: string
          format: date-time
        current_period_start:
          type: string
          format: date-time
        current_period_end:
          type: string
          format: date-time

    # Enhanced Compliance Schemas
    ComplianceFramework:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        category:
          type: string
        version:
          type: string
        regulatory_body:
          type: string

    ComplianceControl:
      type: object
      properties:
        id:
          type: string
          format: uuid
        framework_id:
          type: string
          format: uuid
        control_id:
          type: string
        name:
          type: string
        description:
          type: string
        severity:
          type: string
          enum: [critical, high, medium, low]
        control_family:
          type: string
        automation_support:
          type: string
          enum: [automated, hybrid, manual]
        priority:
          type: string

    ComplianceAssessment:
      type: object
      properties:
        id:
          type: string
          format: uuid
        framework_id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        assessment_type:
          type: string
          enum: [automated, manual, hybrid]
        status:
          type: string
          enum: [pending, in_progress, completed, failed]
        total_controls:
          type: integer
        passed_controls:
          type: integer
        failed_controls:
          type: integer
        not_applicable:
          type: integer
        score:
          type: number
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        initiated_by:
          type: string

    ComplianceEvidence:
      type: object
      properties:
        id:
          type: string
          format: uuid
        control_id:
          type: string
          format: uuid
        evidence_type:
          type: string
          enum: [screenshot, log, config, report, attestation]
        title:
          type: string
        description:
          type: string
        storage_type:
          type: string
        storage_path:
          type: string
        collected_at:
          type: string
          format: date-time
        collected_by:
          type: string
        is_current:
          type: boolean
        review_status:
          type: string
          enum: [pending, approved, rejected]

    ComplianceExemption:
      type: object
      properties:
        id:
          type: string
          format: uuid
        control_id:
          type: string
          format: uuid
        asset_id:
          type: string
          format: uuid
        site_id:
          type: string
          format: uuid
        reason:
          type: string
        risk_acceptance:
          type: string
        compensating_controls:
          type: string
        approved_by:
          type: string
        approved_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
        status:
          type: string
          enum: [active, expired, revoked]

    ComplianceScore:
      type: object
      properties:
        org_id:
          type: string
          format: uuid
        framework_id:
          type: string
          format: uuid
        assessment_count:
          type: integer
        average_score:
          type: number
        total_passed:
          type: integer
        total_failed:
          type: integer
        total_not_applicable:
          type: integer
        pass_rate:
          type: number

    # SBOM Schemas
    SBOM:
      type: object
      properties:
        id:
          type: string
          format: uuid
        org_id:
          type: string
          format: uuid
        image_id:
          type: string
          format: uuid
        image_name:
          type: string
        image_version:
          type: string
        format:
          type: string
          enum: [spdx, cyclonedx]
        spec_version:
          type: string
        component_count:
          type: integer
        vulnerability_count:
          type: integer
        license_count:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    SBOMDetail:
      allOf:
        - $ref: '#/components/schemas/SBOM'
        - type: object
          properties:
            packages:
              type: array
              items:
                $ref: '#/components/schemas/SBOMPackage'
            document_namespace:
              type: string
            creators:
              type: array
              items:
                type: string

    SBOMPackage:
      type: object
      properties:
        id:
          type: string
          format: uuid
        sbom_id:
          type: string
          format: uuid
        name:
          type: string
        version:
          type: string
        type:
          type: string
          enum: [library, framework, application, operating-system, device, firmware, file]
        license:
          type: string
        supplier:
          type: string
        download_location:
          type: string
        files_analyzed:
          type: boolean
        checksums:
          type: array
          items:
            type: object
            properties:
              algorithm:
                type: string
              value:
                type: string
        external_refs:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
              locator:
                type: string

    SBOMVulnerability:
      type: object
      properties:
        id:
          type: string
          format: uuid
        sbom_id:
          type: string
          format: uuid
        package_id:
          type: string
          format: uuid
        cve_id:
          type: string
        severity:
          type: string
          enum: [critical, high, medium, low, unknown]
        cvss_score:
          type: number
        cvss_vector:
          type: string
        description:
          type: string
        published_at:
          type: string
          format: date-time
        modified_at:
          type: string
          format: date-time
        fix_available:
          type: boolean
        fixed_version:
          type: string
        references:
          type: array
          items:
            type: string

    LicenseSummary:
      type: object
      properties:
        total_licenses:
          type: integer
        by_license:
          type: array
          items:
            type: object
            properties:
              license:
                type: string
              count:
                type: integer
              risk_level:
                type: string
                enum: [low, medium, high]
        copyleft_count:
          type: integer
        permissive_count:
          type: integer
        unknown_count:
          type: integer

    # InSpec Schemas
    InSpecProfile:
      type: object
      properties:
        id:
          type: string
          format: uuid
        org_id:
          type: string
          format: uuid
        name:
          type: string
        title:
          type: string
        description:
          type: string
        version:
          type: string
        framework:
          type: string
          enum: [cis, stig, hipaa, pci-dss, soc2, custom]
        platform:
          type: string
          enum: [linux, windows, docker, kubernetes]
        control_count:
          type: integer
        is_system:
          type: boolean
        source_url:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    InSpecProfileDetail:
      allOf:
        - $ref: '#/components/schemas/InSpecProfile'
        - type: object
          properties:
            controls:
              type: array
              items:
                $ref: '#/components/schemas/InSpecControl'
            dependencies:
              type: array
              items:
                type: string
            supports:
              type: array
              items:
                type: object
                properties:
                  platform:
                    type: string
                  platform_family:
                    type: string

    InSpecControl:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        description:
          type: string
        impact:
          type: number
          minimum: 0
          maximum: 1
        tags:
          type: object
          additionalProperties:
            type: string
        refs:
          type: array
          items:
            type: string

    CreateInSpecProfile:
      type: object
      required: [name, title, platform]
      properties:
        name:
          type: string
        title:
          type: string
        description:
          type: string
        version:
          type: string
          default: "1.0.0"
        framework:
          type: string
          enum: [cis, stig, hipaa, pci-dss, soc2, custom]
          default: custom
        platform:
          type: string
          enum: [linux, windows, docker, kubernetes]
        source_url:
          type: string

    InSpecRun:
      type: object
      properties:
        id:
          type: string
          format: uuid
        org_id:
          type: string
          format: uuid
        profile_id:
          type: string
          format: uuid
        profile_name:
          type: string
        status:
          type: string
          enum: [pending, running, completed, failed]
        score:
          type: number
          minimum: 0
          maximum: 100
        passed:
          type: integer
        failed:
          type: integer
        skipped:
          type: integer
        total:
          type: integer
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        triggered_by:
          type: string
        error:
          type: string

    InSpecRunDetail:
      allOf:
        - $ref: '#/components/schemas/InSpecRun'
        - type: object
          properties:
            target_assets:
              type: array
              items:
                type: object
                properties:
                  asset_id:
                    type: string
                    format: uuid
                  asset_name:
                    type: string
                  status:
                    type: string
            controls:
              type: array
              items:
                $ref: '#/components/schemas/InSpecControlResult'

    InSpecControlResult:
      type: object
      properties:
        control_id:
          type: string
        title:
          type: string
        status:
          type: string
          enum: [passed, failed, skipped]
        impact:
          type: number
        message:
          type: string
        run_time:
          type: number
        asset_id:
          type: string
          format: uuid

    InSpecSchedule:
      type: object
      properties:
        id:
          type: string
          format: uuid
        org_id:
          type: string
          format: uuid
        profile_id:
          type: string
          format: uuid
        profile_name:
          type: string
        name:
          type: string
        description:
          type: string
        cron_expression:
          type: string
        enabled:
          type: boolean
        target_filter:
          type: object
          properties:
            site_ids:
              type: array
              items:
                type: string
                format: uuid
            asset_ids:
              type: array
              items:
                type: string
                format: uuid
            tags:
              type: object
              additionalProperties:
                type: string
        last_run_at:
          type: string
          format: date-time
        next_run_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateInSpecSchedule:
      type: object
      required: [profile_id, name, cron_expression]
      properties:
        profile_id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        cron_expression:
          type: string
        enabled:
          type: boolean
          default: true
        target_filter:
          type: object
          properties:
            site_ids:
              type: array
              items:
                type: string
                format: uuid
            asset_ids:
              type: array
              items:
                type: string
                format: uuid
            tags:
              type: object
              additionalProperties:
                type: string

    UpdateInSpecSchedule:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        cron_expression:
          type: string
        enabled:
          type: boolean
        target_filter:
          type: object
          properties:
            site_ids:
              type: array
              items:
                type: string
                format: uuid
            asset_ids:
              type: array
              items:
                type: string
                format: uuid
            tags:
              type: object
              additionalProperties:
                type: string

    Error:
      type: object
      properties:
        error:
          type: string
        code:
          type: string
        details:
          type: object

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Forbidden:
      description: Permission denied
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
