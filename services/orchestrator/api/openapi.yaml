openapi: 3.0.3
info:
  title: QL-RF AI Orchestrator API
  description: |
    The AI Orchestrator converts natural language requests into validated,
    auditable infrastructure operations through specialist AI agents.
  version: 1.0.0
  contact:
    name: QL-RF Team
    email: support@quantumlayer.com

servers:
  - url: http://localhost:8083
    description: Local development
  - url: https://api.ql-rf.example.com
    description: Production

tags:
  - name: Tasks
    description: Task management endpoints
  - name: Executions
    description: Execution management endpoints
  - name: CVE Alerts
    description: CVE vulnerability alert management
  - name: Patch Campaigns
    description: Patch campaign orchestration and rollout management
  - name: Metadata
    description: Agents and tools metadata

paths:
  /api/v1/ai/execute:
    post:
      summary: Submit a new task
      description: Submit a natural language intent to be processed by AI agents
      tags:
        - Tasks
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExecuteRequest'
            example:
              intent: "Fix drift on production web servers"
              org_id: "org-123"
              environment: "production"
              context:
                fleet_size: 100
                drift_score: 85
      responses:
        '200':
          description: Task created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/ai/tasks:
    get:
      summary: List tasks
      description: List all tasks with optional filtering
      tags:
        - Tasks
      parameters:
        - name: org_id
          in: query
          description: Filter by organization ID
          schema:
            type: string
        - name: state
          in: query
          description: Filter by task state
          schema:
            type: string
            enum: [pending, planned, approved, rejected, executing, completed, failed]
        - name: limit
          in: query
          description: Maximum number of results
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          description: Offset for pagination
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: List of tasks
          content:
            application/json:
              schema:
                type: object
                properties:
                  tasks:
                    type: array
                    items:
                      $ref: '#/components/schemas/TaskWithPlan'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/ai/tasks/{taskId}:
    get:
      summary: Get task details
      description: Get detailed information about a specific task
      tags:
        - Tasks
      parameters:
        - $ref: '#/components/parameters/taskId'
      responses:
        '200':
          description: Task details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskWithPlan'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/ai/tasks/{taskId}/approve:
    post:
      summary: Approve a task
      description: Approve a task for execution
      tags:
        - Tasks
      parameters:
        - $ref: '#/components/parameters/taskId'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  description: Optional approval reason
      responses:
        '200':
          description: Task approved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskWithPlan'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/ai/tasks/{taskId}/reject:
    post:
      summary: Reject a task
      description: Reject a task
      tags:
        - Tasks
      parameters:
        - $ref: '#/components/parameters/taskId'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  description: Rejection reason
      responses:
        '200':
          description: Task rejected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskWithPlan'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/ai/tasks/{taskId}/executions:
    get:
      summary: List task executions
      description: List all executions for a specific task
      tags:
        - Executions
      parameters:
        - $ref: '#/components/parameters/taskId'
      responses:
        '200':
          description: List of executions
          content:
            application/json:
              schema:
                type: object
                properties:
                  executions:
                    type: array
                    items:
                      $ref: '#/components/schemas/Execution'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/ai/executions/{executionId}:
    get:
      summary: Get execution details
      description: Get detailed information about a specific execution
      tags:
        - Executions
      parameters:
        - $ref: '#/components/parameters/executionId'
      responses:
        '200':
          description: Execution details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Execution'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/ai/executions/{executionId}/pause:
    post:
      summary: Pause execution
      description: Pause a running execution
      tags:
        - Executions
      parameters:
        - $ref: '#/components/parameters/executionId'
      responses:
        '200':
          description: Execution paused
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/ai/executions/{executionId}/resume:
    post:
      summary: Resume execution
      description: Resume a paused execution
      tags:
        - Executions
      parameters:
        - $ref: '#/components/parameters/executionId'
      responses:
        '200':
          description: Execution resumed
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/ai/executions/{executionId}/cancel:
    post:
      summary: Cancel execution
      description: Cancel a running or paused execution
      tags:
        - Executions
      parameters:
        - $ref: '#/components/parameters/executionId'
      responses:
        '200':
          description: Execution cancelled
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/ai/agents:
    get:
      summary: List agents
      description: List all available AI agents
      tags:
        - Metadata
      responses:
        '200':
          description: List of agents
          content:
            application/json:
              schema:
                type: object
                properties:
                  agents:
                    type: array
                    items:
                      $ref: '#/components/schemas/Agent'

  /api/v1/ai/tools:
    get:
      summary: List tools
      description: List all available tools
      tags:
        - Metadata
      responses:
        '200':
          description: List of tools
          content:
            application/json:
              schema:
                type: object
                properties:
                  tools:
                    type: array
                    items:
                      $ref: '#/components/schemas/Tool'

  # ===========================================================================
  # CVE Alert Endpoints
  # ===========================================================================

  /api/v1/cve-alerts:
    get:
      summary: List CVE alerts
      description: List CVE alerts with optional filtering and pagination
      tags:
        - CVE Alerts
      parameters:
        - name: severity
          in: query
          description: Filter by severity
          schema:
            type: string
            enum: [critical, high, medium, low, unknown]
        - name: status
          in: query
          description: Filter by alert status
          schema:
            type: string
            enum: [new, investigating, confirmed, in_progress, resolved, dismissed, auto_resolved]
        - name: priority
          in: query
          description: Filter by priority
          schema:
            type: string
            enum: [p1, p2, p3, p4]
        - name: cve_id
          in: query
          description: Filter by specific CVE ID
          schema:
            type: string
        - name: min_urgency_score
          in: query
          description: Minimum urgency score (0-100)
          schema:
            type: integer
            minimum: 0
            maximum: 100
        - name: sla_breached
          in: query
          description: Filter by SLA breach status
          schema:
            type: boolean
        - name: has_exploit
          in: query
          description: Filter by exploit availability
          schema:
            type: boolean
        - name: cisa_kev_only
          in: query
          description: Only show CISA KEV listed CVEs
          schema:
            type: boolean
        - name: page
          in: query
          description: Page number (1-indexed)
          schema:
            type: integer
            default: 1
            minimum: 1
        - name: page_size
          in: query
          description: Items per page
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: List of CVE alerts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CVEAlertListResponse'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/cve-alerts/summary:
    get:
      summary: Get CVE alerts summary
      description: Get aggregated statistics for CVE alerts
      tags:
        - CVE Alerts
      responses:
        '200':
          description: CVE alert summary statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CVEAlertSummary'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/cve-alerts/{alertId}:
    get:
      summary: Get CVE alert details
      description: Get detailed information about a specific CVE alert including blast radius
      tags:
        - CVE Alerts
      parameters:
        - $ref: '#/components/parameters/alertId'
      responses:
        '200':
          description: CVE alert with blast radius details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CVEAlertWithBlastRadius'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/cve-alerts/{alertId}/status:
    patch:
      summary: Update CVE alert status
      description: Update the status of a CVE alert (investigate, resolve, dismiss)
      tags:
        - CVE Alerts
      parameters:
        - $ref: '#/components/parameters/alertId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCVEAlertStatusRequest'
      responses:
        '200':
          description: Updated CVE alert
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CVEAlert'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/cve-alerts/{alertId}/blast-radius:
    get:
      summary: Get blast radius
      description: Calculate and return the full blast radius for a CVE alert
      tags:
        - CVE Alerts
      parameters:
        - $ref: '#/components/parameters/alertId'
      responses:
        '200':
          description: Blast radius calculation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BlastRadiusResult'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/cve-alerts/{alertId}/create-campaign:
    post:
      summary: Create patch campaign from alert
      description: Create a new patch campaign to remediate affected assets
      tags:
        - CVE Alerts
      parameters:
        - $ref: '#/components/parameters/alertId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePatchCampaignRequest'
      responses:
        '201':
          description: Patch campaign created
          content:
            application/json:
              schema:
                type: object
                properties:
                  campaign_id:
                    type: string
                    format: uuid
                  alert_id:
                    type: string
                    format: uuid
                  message:
                    type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  # ===========================================================================
  # Patch Campaign Endpoints
  # ===========================================================================

  /api/v1/patch-campaigns:
    get:
      summary: List patch campaigns
      description: List patch campaigns with optional filtering and pagination
      tags:
        - Patch Campaigns
      parameters:
        - name: status
          in: query
          description: Filter by campaign status
          schema:
            type: string
            enum: [draft, pending_approval, approved, scheduled, in_progress, paused, completed, failed, rolled_back, cancelled]
        - name: campaign_type
          in: query
          description: Filter by campaign type
          schema:
            type: string
        - name: page
          in: query
          description: Page number (1-indexed)
          schema:
            type: integer
            default: 1
            minimum: 1
        - name: page_size
          in: query
          description: Items per page
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: List of patch campaigns
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PatchCampaignListResponse'
        '500':
          $ref: '#/components/responses/InternalError'
    post:
      summary: Create patch campaign
      description: Create a new patch campaign
      tags:
        - Patch Campaigns
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePatchCampaignRequest'
      responses:
        '201':
          description: Patch campaign created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PatchCampaign'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/patch-campaigns/summary:
    get:
      summary: Get patch campaign summary
      description: Get aggregated statistics for patch campaigns
      tags:
        - Patch Campaigns
      responses:
        '200':
          description: Patch campaign summary statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PatchCampaignSummary'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/patch-campaigns/{campaignId}:
    get:
      summary: Get patch campaign details
      description: Get detailed information about a specific patch campaign
      tags:
        - Patch Campaigns
      parameters:
        - $ref: '#/components/parameters/campaignId'
      responses:
        '200':
          description: Patch campaign details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PatchCampaign'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/patch-campaigns/{campaignId}/phases:
    get:
      summary: Get campaign phases
      description: Get all phases for a patch campaign
      tags:
        - Patch Campaigns
      parameters:
        - $ref: '#/components/parameters/campaignId'
      responses:
        '200':
          description: Campaign phases
          content:
            application/json:
              schema:
                type: object
                properties:
                  campaign_id:
                    type: string
                    format: uuid
                  phases:
                    type: array
                    items:
                      $ref: '#/components/schemas/PatchCampaignPhase'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/patch-campaigns/{campaignId}/assets:
    get:
      summary: Get campaign assets
      description: Get all assets affected by a patch campaign
      tags:
        - Patch Campaigns
      parameters:
        - $ref: '#/components/parameters/campaignId'
        - name: status
          in: query
          description: Filter by asset status
          schema:
            type: string
        - name: phase_id
          in: query
          description: Filter by phase ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Campaign assets
          content:
            application/json:
              schema:
                type: object
                properties:
                  campaign_id:
                    type: string
                    format: uuid
                  assets:
                    type: array
                    items:
                      $ref: '#/components/schemas/PatchCampaignAsset'
                  total:
                    type: integer
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/patch-campaigns/{campaignId}/progress:
    get:
      summary: Get campaign progress
      description: Get real-time progress information for a patch campaign
      tags:
        - Patch Campaigns
      parameters:
        - $ref: '#/components/parameters/campaignId'
      responses:
        '200':
          description: Campaign progress
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PatchCampaignProgress'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/patch-campaigns/{campaignId}/approve:
    post:
      summary: Approve patch campaign
      description: Approve a patch campaign for execution
      tags:
        - Patch Campaigns
      parameters:
        - $ref: '#/components/parameters/campaignId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApprovePatchCampaignRequest'
      responses:
        '200':
          description: Campaign approved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PatchCampaign'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/patch-campaigns/{campaignId}/reject:
    post:
      summary: Reject patch campaign
      description: Reject a patch campaign
      tags:
        - Patch Campaigns
      parameters:
        - $ref: '#/components/parameters/campaignId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RejectPatchCampaignRequest'
      responses:
        '200':
          description: Campaign rejected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PatchCampaign'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/patch-campaigns/{campaignId}/start:
    post:
      summary: Start patch campaign
      description: Start an approved patch campaign
      tags:
        - Patch Campaigns
      parameters:
        - $ref: '#/components/parameters/campaignId'
      responses:
        '200':
          description: Campaign started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PatchCampaign'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/patch-campaigns/{campaignId}/pause:
    post:
      summary: Pause patch campaign
      description: Pause a running patch campaign
      tags:
        - Patch Campaigns
      parameters:
        - $ref: '#/components/parameters/campaignId'
      responses:
        '200':
          description: Campaign paused
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PatchCampaign'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/patch-campaigns/{campaignId}/resume:
    post:
      summary: Resume patch campaign
      description: Resume a paused patch campaign
      tags:
        - Patch Campaigns
      parameters:
        - $ref: '#/components/parameters/campaignId'
      responses:
        '200':
          description: Campaign resumed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PatchCampaign'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/patch-campaigns/{campaignId}/cancel:
    post:
      summary: Cancel patch campaign
      description: Cancel a patch campaign
      tags:
        - Patch Campaigns
      parameters:
        - $ref: '#/components/parameters/campaignId'
      responses:
        '200':
          description: Campaign cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PatchCampaign'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/patch-campaigns/{campaignId}/rollback:
    post:
      summary: Trigger rollback
      description: Trigger a rollback for a patch campaign
      tags:
        - Patch Campaigns
      parameters:
        - $ref: '#/components/parameters/campaignId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TriggerRollbackRequest'
      responses:
        '200':
          description: Rollback triggered
          content:
            application/json:
              schema:
                type: object
                properties:
                  campaign:
                    $ref: '#/components/schemas/PatchCampaign'
                  message:
                    type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /health:
    get:
      summary: Health check
      description: Liveness probe endpoint
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /ready:
    get:
      summary: Readiness check
      description: Readiness probe endpoint (includes DB connectivity)
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ready
        '503':
          description: Service is not ready

components:
  parameters:
    taskId:
      name: taskId
      in: path
      required: true
      description: Task ID
      schema:
        type: string
        format: uuid
    executionId:
      name: executionId
      in: path
      required: true
      description: Execution ID
      schema:
        type: string
        format: uuid
    alertId:
      name: alertId
      in: path
      required: true
      description: CVE Alert ID
      schema:
        type: string
        format: uuid
    campaignId:
      name: campaignId
      in: path
      required: true
      description: Patch Campaign ID
      schema:
        type: string
        format: uuid

  schemas:
    ExecuteRequest:
      type: object
      required:
        - intent
        - org_id
      properties:
        intent:
          type: string
          description: Natural language description of what to do
          example: "Fix drift on production web servers"
        org_id:
          type: string
          description: Organization ID
        environment:
          type: string
          description: Target environment
          enum: [development, staging, production]
          default: production
        context:
          type: object
          description: Additional context for the task
          additionalProperties: true

    TaskResponse:
      type: object
      properties:
        task_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending_approval, approved, rejected, executing, completed, failed]
        task_spec:
          $ref: '#/components/schemas/TaskSpec'
        agent_result:
          $ref: '#/components/schemas/AgentResult'
        quality_score:
          $ref: '#/components/schemas/QualityScore'
        requires_hitl:
          type: boolean
        message:
          type: string

    TaskWithPlan:
      type: object
      properties:
        id:
          type: string
          format: uuid
        org_id:
          type: string
        user_intent:
          type: string
        task_spec:
          type: object
        state:
          type: string
          enum: [pending, planned, approved, rejected, executing, completed, failed]
        source:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        plan:
          $ref: '#/components/schemas/Plan'
        risk_level:
          type: string
          enum: [low, medium, high, critical]
        task_type:
          type: string
        hitl_required:
          type: boolean

    TaskSpec:
      type: object
      properties:
        task_type:
          type: string
          description: Type of task
          example: drift_remediation
        goal:
          type: string
          description: Interpreted goal
        risk_level:
          type: string
          enum: [low, medium, high, critical]
        environment:
          type: string

    AgentResult:
      type: object
      properties:
        agent_name:
          type: string
          example: drift_agent
        plan:
          type: string
          description: Generated plan in markdown format
        summary:
          type: string
          description: Brief summary of the plan
        affected_assets:
          type: integer
        risk_level:
          type: string
        actions:
          type: array
          items:
            $ref: '#/components/schemas/HITLAction'
        evidence:
          type: object
        tokens_used:
          type: integer

    HITLAction:
      type: object
      properties:
        type:
          type: string
          enum: [approve, modify, reject]
        label:
          type: string
        description:
          type: string

    QualityScore:
      type: object
      properties:
        total:
          type: integer
          minimum: 0
          maximum: 100
        structural:
          type: integer
        policy_compliance:
          type: integer
        test_coverage:
          type: integer
        operational_history:
          type: integer
        human_review:
          type: integer
        dimensions:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/ScoreDimension'
        allowed_environments:
          type: array
          items:
            type: string
        requires_approval:
          type: boolean
        computed_at:
          type: string
          format: date-time

    ScoreDimension:
      type: object
      properties:
        score:
          type: integer
        max_score:
          type: integer
        passed:
          type: array
          items:
            type: string
        failed:
          type: array
          items:
            type: string
        description:
          type: string

    Plan:
      type: object
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
        payload:
          type: object
          additionalProperties: true
        state:
          type: string
          enum: [pending, awaiting_approval, approved, rejected, executing, completed, failed]
        approved_by:
          type: string
        approved_at:
          type: string
          format: date-time
        rejection_reason:
          type: string
        created_at:
          type: string
          format: date-time

    Execution:
      type: object
      properties:
        id:
          type: string
          format: uuid
        task_id:
          type: string
          format: uuid
        plan_id:
          type: string
          format: uuid
        org_id:
          type: string
        status:
          type: string
          enum: [pending, running, paused, completed, failed, rolled_back, cancelled]
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        started_by:
          type: string
        phases:
          type: array
          items:
            $ref: '#/components/schemas/PhaseExecution'
        current_phase:
          type: integer
        total_phases:
          type: integer
        error:
          type: string
        rollback_error:
          type: string
        metadata:
          type: object

    PhaseExecution:
      type: object
      properties:
        name:
          type: string
        status:
          type: string
          enum: [pending, running, waiting, completed, failed, skipped]
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        assets:
          type: array
          items:
            $ref: '#/components/schemas/AssetExecution'
        wait_until:
          type: string
          format: date-time
        error:
          type: string
        metrics:
          type: object

    AssetExecution:
      type: object
      properties:
        asset_id:
          type: string
        asset_name:
          type: string
        status:
          type: string
          enum: [pending, running, completed, failed, skipped]
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        error:
          type: string
        output:
          type: string

    Agent:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        supported_tasks:
          type: array
          items:
            type: string
        required_tools:
          type: array
          items:
            type: string

    Tool:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        risk_level:
          type: string
          enum: [read_only, plan_only, state_change, state_change_prod]
        requires_approval:
          type: boolean
        parameters:
          type: object

    # =========================================================================
    # CVE Alert Schemas
    # =========================================================================

    CVEAlert:
      type: object
      properties:
        id:
          type: string
          format: uuid
        org_id:
          type: string
          format: uuid
        cve_id:
          type: string
          example: CVE-2024-1234
        cve_cache_id:
          type: string
          format: uuid
        severity:
          type: string
          enum: [critical, high, medium, low, unknown]
        urgency_score:
          type: integer
          minimum: 0
          maximum: 100
          description: Urgency score based on CVSS, exploitability, and blast radius
        status:
          type: string
          enum: [new, investigating, confirmed, in_progress, resolved, dismissed, auto_resolved]
        priority:
          type: string
          enum: [p1, p2, p3, p4]
        sla_due_at:
          type: string
          format: date-time
        sla_breached:
          type: boolean
        affected_images_count:
          type: integer
        affected_assets_count:
          type: integer
        affected_packages_count:
          type: integer
        production_assets_count:
          type: integer
        assigned_to:
          type: string
        assigned_at:
          type: string
          format: date-time
        resolution_type:
          type: string
          enum: [patched, upgraded, mitigated, accepted_risk, false_positive]
        resolution_notes:
          type: string
        resolved_by:
          type: string
        resolved_at:
          type: string
          format: date-time
        patch_campaign_id:
          type: string
          format: uuid
        ticket_id:
          type: string
        detected_at:
          type: string
          format: date-time
        first_seen_at:
          type: string
          format: date-time
        last_seen_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        cve_details:
          $ref: '#/components/schemas/CVECache'

    CVECache:
      type: object
      description: Normalized CVE data from multiple sources
      properties:
        id:
          type: string
          format: uuid
        cve_id:
          type: string
          example: CVE-2024-1234
        cvss_v3_score:
          type: number
          format: float
          minimum: 0
          maximum: 10
        cvss_v3_vector:
          type: string
        severity:
          type: string
          enum: [critical, high, medium, low, unknown]
        epss_score:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: EPSS probability of exploitation
        epss_percentile:
          type: number
          format: float
        exploit_available:
          type: boolean
        exploit_maturity:
          type: string
          enum: [unproven, poc, functional, high]
        cisa_kev_listed:
          type: boolean
        cisa_kev_due_date:
          type: string
          format: date-time
        cisa_kev_ransomware:
          type: boolean
        description:
          type: string
        published_date:
          type: string
          format: date-time
        modified_date:
          type: string
          format: date-time
        primary_source:
          type: string
          enum: [nvd, osv, github, cisa_kev]
        reference_urls:
          type: array
          items:
            type: string
            format: uri
        remediation_summary:
          type: string

    CVEAlertListResponse:
      type: object
      properties:
        alerts:
          type: array
          items:
            $ref: '#/components/schemas/CVEAlert'
        total:
          type: integer
        page:
          type: integer
        page_size:
          type: integer
        total_pages:
          type: integer

    CVEAlertSummary:
      type: object
      description: Aggregated CVE alert statistics
      properties:
        total_alerts:
          type: integer
        new_alerts:
          type: integer
        in_progress_alerts:
          type: integer
        resolved_alerts:
          type: integer
        critical_alerts:
          type: integer
        high_alerts:
          type: integer
        medium_alerts:
          type: integer
        low_alerts:
          type: integer
        sla_breached_alerts:
          type: integer
        exploitable_alerts:
          type: integer
        cisa_kev_alerts:
          type: integer
        average_urgency_score:
          type: integer
        total_affected_assets:
          type: integer
        production_affected_assets:
          type: integer

    CVEAlertWithBlastRadius:
      allOf:
        - $ref: '#/components/schemas/CVEAlert'
        - type: object
          properties:
            affected_items:
              type: array
              items:
                $ref: '#/components/schemas/CVEAlertAffectedItem'
            affected_platforms:
              type: array
              items:
                type: string
            affected_regions:
              type: array
              items:
                type: string

    CVEAlertAffectedItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        alert_id:
          type: string
          format: uuid
        item_type:
          type: string
          enum: [package, image, asset]
        package_name:
          type: string
        package_version:
          type: string
        package_type:
          type: string
        fixed_version:
          type: string
        image_family:
          type: string
        image_version:
          type: string
        asset_name:
          type: string
        asset_platform:
          type: string
          enum: [aws, azure, gcp, vsphere, kubernetes]
        asset_environment:
          type: string
          enum: [development, staging, production]
        asset_region:
          type: string
        is_production:
          type: boolean
        inherited_from_image_id:
          type: string
          format: uuid
        lineage_depth:
          type: integer
        item_status:
          type: string
          enum: [vulnerable, patch_pending, patching, patched, mitigated, not_affected, decommissioned]

    BlastRadiusResult:
      type: object
      description: Full blast radius calculation for a CVE
      properties:
        cve_id:
          type: string
        total_packages:
          type: integer
        total_images:
          type: integer
        total_assets:
          type: integer
        production_assets:
          type: integer
        affected_platforms:
          type: array
          items:
            type: string
        affected_regions:
          type: array
          items:
            type: string
        affected_packages:
          type: array
          items:
            $ref: '#/components/schemas/AffectedPackage'
        affected_images:
          type: array
          items:
            $ref: '#/components/schemas/AffectedImage'
        affected_assets:
          type: array
          items:
            $ref: '#/components/schemas/AffectedAsset'
        urgency_score:
          type: integer
          minimum: 0
          maximum: 100
        calculated_at:
          type: string
          format: date-time

    AffectedPackage:
      type: object
      properties:
        package_id:
          type: string
          format: uuid
        sbom_id:
          type: string
          format: uuid
        image_id:
          type: string
          format: uuid
        package_name:
          type: string
        package_version:
          type: string
        package_type:
          type: string
        fixed_version:
          type: string

    AffectedImage:
      type: object
      properties:
        image_id:
          type: string
          format: uuid
        image_family:
          type: string
        image_version:
          type: string
        is_direct:
          type: boolean
          description: True if CVE directly affects this image's packages
        inherited_from:
          type: string
          format: uuid
          description: Parent image ID if vulnerability inherited through lineage
        lineage_depth:
          type: integer
        child_image_ids:
          type: array
          items:
            type: string
            format: uuid

    AffectedAsset:
      type: object
      properties:
        asset_id:
          type: string
          format: uuid
        asset_name:
          type: string
        platform:
          type: string
        region:
          type: string
        environment:
          type: string
        is_production:
          type: boolean
        image_ref:
          type: string
        image_id:
          type: string
          format: uuid

    UpdateCVEAlertStatusRequest:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [new, investigating, confirmed, in_progress, resolved, dismissed]
        assigned_to:
          type: string
        resolution_type:
          type: string
          enum: [patched, upgraded, mitigated, accepted_risk, false_positive]
        resolution_notes:
          type: string
        ticket_id:
          type: string

    CreatePatchCampaignRequest:
      type: object
      required:
        - name
        - campaign_type
        - rollout_strategy
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
        description:
          type: string
        campaign_type:
          type: string
          enum: [cve_response, emergency, scheduled, maintenance]
        cve_alert_ids:
          type: array
          items:
            type: string
            format: uuid
        rollout_strategy:
          type: string
          enum: [immediate, canary, blue_green, rolling]
        canary_percentage:
          type: integer
          minimum: 1
          maximum: 50
          default: 5
        wave_percentage:
          type: integer
          minimum: 10
          maximum: 100
          default: 25
        failure_threshold_percentage:
          type: integer
          minimum: 1
          maximum: 100
          default: 5
        health_check_enabled:
          type: boolean
          default: true
        auto_rollback_enabled:
          type: boolean
          default: true
        requires_approval:
          type: boolean
          default: true
        scheduled_start_at:
          type: string
          format: date-time
        target_asset_ids:
          type: array
          items:
            type: string
            format: uuid

    # =========================================================================
    # Patch Campaign Schemas
    # =========================================================================

    PatchCampaignStatus:
      type: string
      enum: [draft, pending_approval, approved, scheduled, in_progress, paused, completed, failed, rolled_back, cancelled]
      description: Status of a patch campaign

    RolloutStrategy:
      type: string
      enum: [immediate, canary, rolling, blue_green]
      description: Deployment rollout strategy

    PatchCampaign:
      type: object
      properties:
        id:
          type: string
          format: uuid
        org_id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        campaign_type:
          type: string
        cve_alert_ids:
          type: array
          items:
            type: string
            format: uuid
        status:
          $ref: '#/components/schemas/PatchCampaignStatus'
        requires_approval:
          type: boolean
        approved_by:
          type: string
        approved_at:
          type: string
          format: date-time
        rollout_strategy:
          $ref: '#/components/schemas/RolloutStrategy'
        canary_percentage:
          type: integer
        wave_percentage:
          type: integer
        failure_threshold_percentage:
          type: integer
        health_check_enabled:
          type: boolean
        auto_rollback_enabled:
          type: boolean
        total_assets:
          type: integer
        pending_assets:
          type: integer
        in_progress_assets:
          type: integer
        completed_assets:
          type: integer
        failed_assets:
          type: integer
        skipped_assets:
          type: integer
        scheduled_start_at:
          type: string
          format: date-time
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        created_by:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        phases:
          type: array
          items:
            $ref: '#/components/schemas/PatchCampaignPhase'

    PatchCampaignPhase:
      type: object
      properties:
        id:
          type: string
          format: uuid
        campaign_id:
          type: string
          format: uuid
        phase_number:
          type: integer
        name:
          type: string
        phase_type:
          type: string
        target_percentage:
          type: integer
        status:
          type: string
        total_assets:
          type: integer
        completed_assets:
          type: integer
        failed_assets:
          type: integer
        health_check_passed:
          type: boolean
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time

    PatchCampaignAsset:
      type: object
      properties:
        id:
          type: string
          format: uuid
        campaign_id:
          type: string
          format: uuid
        asset_id:
          type: string
          format: uuid
        asset_name:
          type: string
        platform:
          type: string
        status:
          type: string
        before_version:
          type: string
        after_version:
          type: string
        error_message:
          type: string

    PatchCampaignProgress:
      type: object
      properties:
        campaign_id:
          type: string
          format: uuid
        status:
          type: string
        total_assets:
          type: integer
        completed_assets:
          type: integer
        failed_assets:
          type: integer
        skipped_assets:
          type: integer
        completion_percentage:
          type: number
        failure_percentage:
          type: number
        total_phases:
          type: integer
        completed_phases:
          type: integer
        current_phase:
          type: string
        current_phase_progress:
          type: number
        estimated_completion:
          type: string
          format: date-time
        started_at:
          type: string
          format: date-time
        elapsed_time_minutes:
          type: number

    PatchCampaignSummary:
      type: object
      properties:
        total_campaigns:
          type: integer
        active_campaigns:
          type: integer
        completed_campaigns:
          type: integer
        failed_campaigns:
          type: integer
        total_assets_patched:
          type: integer
        total_rollbacks:
          type: integer
        success_rate:
          type: number

    PatchCampaignListResponse:
      type: object
      properties:
        campaigns:
          type: array
          items:
            $ref: '#/components/schemas/PatchCampaign'
        total:
          type: integer
        page:
          type: integer
        page_size:
          type: integer
        total_pages:
          type: integer

    ApprovePatchCampaignRequest:
      type: object
      required:
        - approved_by
      properties:
        approved_by:
          type: string
        comment:
          type: string

    RejectPatchCampaignRequest:
      type: object
      required:
        - rejected_by
        - reason
      properties:
        rejected_by:
          type: string
        reason:
          type: string

    TriggerRollbackRequest:
      type: object
      required:
        - scope
        - reason
      properties:
        scope:
          type: string
          enum: [all, partial, phase]
        reason:
          type: string
        asset_ids:
          type: array
          items:
            type: string
            format: uuid
        phase_id:
          type: string
          format: uuid

    Error:
      type: object
      properties:
        error:
          type: string
        code:
          type: string
        details:
          type: object

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
