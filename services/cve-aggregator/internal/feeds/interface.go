// Package feeds provides CVE data source integrations.
package feeds

import (
	"context"
	"time"

	"github.com/quantumlayerhq/ql-rf/pkg/models"
)

// Feed defines the interface for CVE data sources.
type Feed interface {
	// Name returns the unique identifier for this feed.
	Name() string

	// DisplayName returns a human-readable name for this feed.
	DisplayName() string

	// FetchCVEs retrieves CVEs modified since the given timestamp.
	// If since is zero, fetches recent CVEs based on feed-specific defaults.
	FetchCVEs(ctx context.Context, since time.Time) ([]*models.CVECache, error)

	// FetchCVE retrieves a specific CVE by ID.
	FetchCVE(ctx context.Context, cveID string) (*models.CVECache, error)

	// HealthCheck verifies the feed is accessible.
	HealthCheck(ctx context.Context) error

	// Priority returns the source priority (lower = more authoritative).
	Priority() int
}

// FeedConfig contains configuration for a feed.
type FeedConfig struct {
	Enabled             bool          `json:"enabled"`
	APIKey              string        `json:"-"` // Sensitive - don't serialize
	PollInterval        time.Duration `json:"pollInterval"`
	RateLimit           int           `json:"rateLimit"`           // Requests per minute
	BatchSize           int           `json:"batchSize"`           // CVEs per request
	Timeout             time.Duration `json:"timeout"`
	RetryCount          int           `json:"retryCount"`
	RetryBackoff        time.Duration `json:"retryBackoff"`
}

// DefaultFeedConfig returns default configuration for feeds.
func DefaultFeedConfig() FeedConfig {
	return FeedConfig{
		Enabled:      true,
		PollInterval: 15 * time.Minute,
		RateLimit:    30,
		BatchSize:    100,
		Timeout:      30 * time.Second,
		RetryCount:   3,
		RetryBackoff: 5 * time.Second,
	}
}

// FeedResult represents the result of a feed fetch operation.
type FeedResult struct {
	Feed         string           `json:"feed"`
	CVEsFound    int              `json:"cvesFound"`
	CVEsNew      int              `json:"cvesNew"`
	CVEsUpdated  int              `json:"cvesUpdated"`
	Duration     time.Duration    `json:"duration"`
	Error        error            `json:"error,omitempty"`
	StartedAt    time.Time        `json:"startedAt"`
	CompletedAt  time.Time        `json:"completedAt"`
}

// FeedManager manages multiple CVE feeds.
type FeedManager struct {
	feeds    map[string]Feed
	configs  map[string]FeedConfig
}

// NewFeedManager creates a new feed manager.
func NewFeedManager() *FeedManager {
	return &FeedManager{
		feeds:   make(map[string]Feed),
		configs: make(map[string]FeedConfig),
	}
}

// RegisterFeed adds a feed to the manager.
func (m *FeedManager) RegisterFeed(feed Feed, config FeedConfig) {
	m.feeds[feed.Name()] = feed
	m.configs[feed.Name()] = config
}

// GetFeed returns a feed by name.
func (m *FeedManager) GetFeed(name string) (Feed, bool) {
	feed, ok := m.feeds[name]
	return feed, ok
}

// GetEnabledFeeds returns all enabled feeds sorted by priority.
func (m *FeedManager) GetEnabledFeeds() []Feed {
	var enabled []Feed
	for name, feed := range m.feeds {
		if config, ok := m.configs[name]; ok && config.Enabled {
			enabled = append(enabled, feed)
		}
	}
	// Sort by priority (lower first)
	for i := 0; i < len(enabled); i++ {
		for j := i + 1; j < len(enabled); j++ {
			if enabled[j].Priority() < enabled[i].Priority() {
				enabled[i], enabled[j] = enabled[j], enabled[i]
			}
		}
	}
	return enabled
}

// GetConfig returns the configuration for a feed.
func (m *FeedManager) GetConfig(name string) (FeedConfig, bool) {
	config, ok := m.configs[name]
	return config, ok
}
