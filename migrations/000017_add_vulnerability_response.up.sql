-- QuantumLayer Resilience Fabric - Vulnerability Response System
-- Migration: 000017_add_vulnerability_response
-- Description: Real-time CVE detection, blast radius analysis, and automated patch orchestration

-- =============================================================================
-- CVE FEED SOURCES
-- =============================================================================

-- Configuration for CVE data sources (NVD, OSV, GitHub, CISA KEV)
CREATE TABLE cve_feed_sources (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- Source identification
    name VARCHAR(63) NOT NULL UNIQUE,          -- nvd, osv, github_advisory, cisa_kev
    display_name VARCHAR(127) NOT NULL,        -- "NVD (National Vulnerability Database)"
    source_type VARCHAR(31) NOT NULL,          -- api, rss, webhook

    -- Connection details
    api_url TEXT NOT NULL,
    api_key_ref VARCHAR(255),                  -- Reference to secret in vault/env

    -- Polling configuration
    poll_interval_minutes INT NOT NULL DEFAULT 15,
    last_poll_at TIMESTAMPTZ,
    last_successful_poll_at TIMESTAMPTZ,
    last_error TEXT,

    -- Status
    enabled BOOLEAN NOT NULL DEFAULT true,
    priority INT NOT NULL DEFAULT 100,         -- Lower = higher priority for deduplication

    -- Metadata
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

COMMENT ON TABLE cve_feed_sources IS 'Configuration for CVE data feed sources';
COMMENT ON COLUMN cve_feed_sources.api_key_ref IS 'Reference to API key in secure storage (never store keys directly)';
COMMENT ON COLUMN cve_feed_sources.priority IS 'Source priority for deduplication (lower = more authoritative)';

-- Insert default feed sources
INSERT INTO cve_feed_sources (name, display_name, source_type, api_url, poll_interval_minutes, priority) VALUES
    ('nvd', 'NVD (National Vulnerability Database)', 'api', 'https://services.nvd.nist.gov/rest/json/cves/2.0', 15, 10),
    ('osv', 'OSV (Open Source Vulnerabilities)', 'api', 'https://api.osv.dev/v1/vulns', 30, 20),
    ('github_advisory', 'GitHub Security Advisories', 'api', 'https://api.github.com/advisories', 60, 30),
    ('cisa_kev', 'CISA Known Exploited Vulnerabilities', 'api', 'https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json', 60, 5);

-- =============================================================================
-- CVE CACHE
-- =============================================================================

-- Normalized CVE data from all sources
CREATE TABLE cve_cache (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- Primary identification
    cve_id VARCHAR(63) NOT NULL UNIQUE,        -- CVE-2024-1234, GHSA-xxxx-xxxx-xxxx

    -- Severity metrics
    cvss_v3_score DECIMAL(3,1) CHECK (cvss_v3_score >= 0.0 AND cvss_v3_score <= 10.0),
    cvss_v3_vector VARCHAR(255),
    cvss_v2_score DECIMAL(3,1) CHECK (cvss_v2_score >= 0.0 AND cvss_v2_score <= 10.0),
    severity VARCHAR(31) NOT NULL CHECK (severity IN ('critical', 'high', 'medium', 'low', 'unknown')),

    -- EPSS (Exploit Prediction Scoring System)
    epss_score DECIMAL(5,4) CHECK (epss_score >= 0.0 AND epss_score <= 1.0),
    epss_percentile DECIMAL(5,2) CHECK (epss_percentile >= 0.0 AND epss_percentile <= 100.0),
    epss_updated_at TIMESTAMPTZ,

    -- Exploit intelligence
    exploit_available BOOLEAN NOT NULL DEFAULT false,
    exploit_maturity VARCHAR(31),              -- unproven, poc, functional, high
    exploit_urls JSONB,                        -- Array of known exploit URLs/repos

    -- CISA KEV tracking
    cisa_kev_listed BOOLEAN NOT NULL DEFAULT false,
    cisa_kev_added_date DATE,
    cisa_kev_due_date DATE,                    -- Required remediation date for federal agencies
    cisa_kev_ransomware BOOLEAN,               -- Known to be used in ransomware

    -- Description and metadata
    description TEXT,
    published_date TIMESTAMPTZ,
    modified_date TIMESTAMPTZ,

    -- Affected configurations (CPE patterns)
    affected_cpe_patterns JSONB,               -- Array of CPE match patterns

    -- Reference URLs
    reference_urls JSONB,                      -- Array of {url, type, source}

    -- Remediation
    remediation_summary TEXT,
    vendor_advisory_urls JSONB,

    -- Source tracking
    primary_source VARCHAR(63) NOT NULL,       -- Which feed first reported this
    sources JSONB NOT NULL DEFAULT '[]',       -- All sources that have this CVE

    -- Caching metadata
    raw_data JSONB,                            -- Original JSON from source (for debugging)
    fetched_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

COMMENT ON TABLE cve_cache IS 'Normalized CVE data aggregated from multiple sources';
COMMENT ON COLUMN cve_cache.epss_score IS 'EPSS score: probability (0-1) that vulnerability will be exploited in next 30 days';
COMMENT ON COLUMN cve_cache.cisa_kev_listed IS 'Whether CVE is in CISA Known Exploited Vulnerabilities catalog';
COMMENT ON COLUMN cve_cache.cisa_kev_due_date IS 'CISA-mandated remediation deadline for federal agencies';

-- =============================================================================
-- CVE ALERTS
-- =============================================================================

-- Per-organization alerts when CVE matches SBOM packages
CREATE TABLE cve_alerts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

    -- CVE reference
    cve_id VARCHAR(63) NOT NULL,
    cve_cache_id UUID REFERENCES cve_cache(id) ON DELETE SET NULL,

    -- Alert classification
    severity VARCHAR(31) NOT NULL CHECK (severity IN ('critical', 'high', 'medium', 'low', 'unknown')),
    urgency_score INT NOT NULL DEFAULT 0 CHECK (urgency_score >= 0 AND urgency_score <= 100),

    -- Status tracking
    status VARCHAR(31) NOT NULL DEFAULT 'new' CHECK (status IN (
        'new',           -- Just detected
        'investigating', -- Being investigated
        'confirmed',     -- Confirmed as affecting org
        'in_progress',   -- Remediation in progress
        'resolved',      -- Fixed/patched
        'dismissed',     -- False positive or accepted risk
        'auto_resolved'  -- Resolved by system (e.g., asset decommissioned)
    )),

    -- Priority and SLA
    priority VARCHAR(31) DEFAULT 'p3' CHECK (priority IN ('p1', 'p2', 'p3', 'p4')),
    sla_due_at TIMESTAMPTZ,
    sla_breached BOOLEAN NOT NULL DEFAULT false,

    -- Blast radius summary (denormalized for quick display)
    affected_images_count INT NOT NULL DEFAULT 0,
    affected_assets_count INT NOT NULL DEFAULT 0,
    affected_packages_count INT NOT NULL DEFAULT 0,
    production_assets_count INT NOT NULL DEFAULT 0,

    -- Assignment
    assigned_to VARCHAR(255),
    assigned_at TIMESTAMPTZ,

    -- Resolution
    resolution_type VARCHAR(31),               -- patched, upgraded, mitigated, accepted_risk, false_positive
    resolution_notes TEXT,
    resolved_by VARCHAR(255),
    resolved_at TIMESTAMPTZ,

    -- Related records
    patch_campaign_id UUID,                    -- Link to patch campaign (FK added later)
    ticket_id VARCHAR(255),                    -- External ticket (Jira, ServiceNow)

    -- Timestamps
    detected_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    first_seen_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    last_seen_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    UNIQUE(org_id, cve_id)
);

COMMENT ON TABLE cve_alerts IS 'CVE alerts for organizations when vulnerabilities match their SBOM packages';
COMMENT ON COLUMN cve_alerts.urgency_score IS 'Calculated urgency (0-100) based on CVSS, EPSS, exploit availability, blast radius';
COMMENT ON COLUMN cve_alerts.sla_due_at IS 'SLA deadline based on severity and organization policy';

-- =============================================================================
-- CVE ALERT AFFECTED ITEMS
-- =============================================================================

-- Detailed blast radius: which packages, images, and assets are affected
CREATE TABLE cve_alert_affected_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    alert_id UUID NOT NULL REFERENCES cve_alerts(id) ON DELETE CASCADE,

    -- What's affected (one of these should be set)
    package_id UUID REFERENCES sbom_packages(id) ON DELETE CASCADE,
    image_id UUID REFERENCES images(id) ON DELETE CASCADE,
    asset_id UUID REFERENCES assets(id) ON DELETE CASCADE,

    -- Item type for easy filtering
    item_type VARCHAR(31) NOT NULL CHECK (item_type IN ('package', 'image', 'asset')),

    -- Package details (denormalized for display)
    package_name VARCHAR(255),
    package_version VARCHAR(127),
    package_type VARCHAR(63),                  -- deb, rpm, npm, etc.
    fixed_version VARCHAR(127),

    -- Image details (denormalized)
    image_family VARCHAR(127),
    image_version VARCHAR(127),

    -- Asset details (denormalized)
    asset_name VARCHAR(255),
    asset_platform VARCHAR(31),
    asset_environment VARCHAR(31),
    asset_region VARCHAR(63),
    is_production BOOLEAN NOT NULL DEFAULT false,

    -- Lineage tracking
    inherited_from_image_id UUID REFERENCES images(id) ON DELETE SET NULL,
    lineage_depth INT NOT NULL DEFAULT 0,      -- 0 = direct, 1+ = inherited

    -- Status for this specific item
    item_status VARCHAR(31) NOT NULL DEFAULT 'vulnerable' CHECK (item_status IN (
        'vulnerable',     -- Still vulnerable
        'patch_pending',  -- Patch queued
        'patching',       -- Patch in progress
        'patched',        -- Patched
        'mitigated',      -- Mitigating controls applied
        'not_affected',   -- False positive for this item
        'decommissioned'  -- Asset no longer exists
    )),

    -- Remediation tracking
    remediation_method VARCHAR(63),            -- ssm_patch, azure_update, k8s_rollout, manual
    remediation_started_at TIMESTAMPTZ,
    remediation_completed_at TIMESTAMPTZ,

    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

COMMENT ON TABLE cve_alert_affected_items IS 'Blast radius details: packages, images, and assets affected by each CVE alert';
COMMENT ON COLUMN cve_alert_affected_items.lineage_depth IS 'Inheritance depth: 0 if package directly in image, 1+ if inherited from parent image';

-- =============================================================================
-- PATCH CAMPAIGNS
-- =============================================================================

-- Multi-phase rollout campaigns for patching vulnerabilities
CREATE TABLE patch_campaigns (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

    -- Campaign identification
    name VARCHAR(255) NOT NULL,
    description TEXT,
    campaign_type VARCHAR(31) NOT NULL CHECK (campaign_type IN (
        'cve_response',    -- Response to specific CVE(s)
        'scheduled',       -- Regular maintenance window
        'emergency',       -- Emergency patch (skip approvals)
        'compliance'       -- Compliance-driven patching
    )),

    -- Related CVE alerts
    cve_alert_ids UUID[] NOT NULL DEFAULT '{}',

    -- Status
    status VARCHAR(31) NOT NULL DEFAULT 'draft' CHECK (status IN (
        'draft',           -- Being created
        'pending_approval',-- Waiting for HITL approval
        'approved',        -- Approved, ready to start
        'scheduled',       -- Scheduled for future start
        'in_progress',     -- Currently executing
        'paused',          -- Temporarily paused
        'completed',       -- Successfully completed
        'failed',          -- Failed (some assets not patched)
        'rolled_back',     -- Rolled back due to issues
        'cancelled'        -- Cancelled before completion
    )),

    -- Approval workflow
    requires_approval BOOLEAN NOT NULL DEFAULT true,
    approval_request_id UUID,                  -- Reference to HITL approval request
    approved_by VARCHAR(255),
    approved_at TIMESTAMPTZ,
    rejection_reason TEXT,

    -- Schedule
    scheduled_start_at TIMESTAMPTZ,
    scheduled_end_at TIMESTAMPTZ,
    maintenance_window_id UUID,                -- Reference to maintenance window if applicable

    -- Progress tracking
    total_assets INT NOT NULL DEFAULT 0,
    pending_assets INT NOT NULL DEFAULT 0,
    in_progress_assets INT NOT NULL DEFAULT 0,
    completed_assets INT NOT NULL DEFAULT 0,
    failed_assets INT NOT NULL DEFAULT 0,
    skipped_assets INT NOT NULL DEFAULT 0,

    -- Rollout configuration
    rollout_strategy VARCHAR(31) NOT NULL DEFAULT 'canary' CHECK (rollout_strategy IN (
        'immediate',       -- All at once
        'canary',          -- Canary then waves
        'blue_green',      -- Blue-green deployment
        'rolling'          -- Rolling update
    )),
    canary_percentage INT DEFAULT 5,
    wave_percentage INT DEFAULT 25,
    failure_threshold_percentage INT DEFAULT 5,

    -- Health check configuration
    health_check_enabled BOOLEAN NOT NULL DEFAULT true,
    health_check_timeout_seconds INT DEFAULT 300,
    health_check_interval_seconds INT DEFAULT 30,

    -- Rollback configuration
    auto_rollback_enabled BOOLEAN NOT NULL DEFAULT true,
    rollback_on_failure_percentage INT DEFAULT 10,

    -- Execution
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,

    -- AI task reference
    ai_task_id UUID REFERENCES ai_tasks(id) ON DELETE SET NULL,

    -- Created by
    created_by VARCHAR(255) NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

COMMENT ON TABLE patch_campaigns IS 'Orchestrated patch campaigns with phased rollout and automatic rollback';
COMMENT ON COLUMN patch_campaigns.failure_threshold_percentage IS 'Percentage of failures that triggers pause/rollback';

-- Add FK from cve_alerts to patch_campaigns
ALTER TABLE cve_alerts ADD CONSTRAINT fk_cve_alerts_patch_campaign
    FOREIGN KEY (patch_campaign_id) REFERENCES patch_campaigns(id) ON DELETE SET NULL;

-- =============================================================================
-- PATCH CAMPAIGN PHASES
-- =============================================================================

-- Phases within a campaign (canary, wave 1, wave 2, etc.)
CREATE TABLE patch_campaign_phases (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    campaign_id UUID NOT NULL REFERENCES patch_campaigns(id) ON DELETE CASCADE,

    -- Phase identification
    phase_number INT NOT NULL,
    name VARCHAR(127) NOT NULL,                -- "Canary", "Wave 1", "Wave 2", etc.
    phase_type VARCHAR(31) NOT NULL CHECK (phase_type IN (
        'canary',          -- Initial canary deployment
        'wave',            -- Production wave
        'final'            -- Final wave (remaining assets)
    )),

    -- Target selection
    target_percentage INT NOT NULL,
    target_asset_ids UUID[] NOT NULL DEFAULT '{}',
    target_criteria JSONB,                     -- Selection criteria: platform, region, env, etc.

    -- Status
    status VARCHAR(31) NOT NULL DEFAULT 'pending' CHECK (status IN (
        'pending',         -- Not started
        'in_progress',     -- Currently executing
        'health_check',    -- Running health checks
        'waiting_approval',-- Waiting for approval to proceed
        'completed',       -- Successfully completed
        'failed',          -- Failed
        'rolled_back',     -- Rolled back
        'skipped'          -- Skipped (e.g., no assets matched)
    )),

    -- Progress
    total_assets INT NOT NULL DEFAULT 0,
    completed_assets INT NOT NULL DEFAULT 0,
    failed_assets INT NOT NULL DEFAULT 0,

    -- Health check results
    health_check_passed BOOLEAN,
    health_check_results JSONB,

    -- Timing
    estimated_duration_minutes INT,
    actual_duration_minutes INT,
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,

    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    UNIQUE(campaign_id, phase_number)
);

COMMENT ON TABLE patch_campaign_phases IS 'Individual phases within a patch campaign (canary, waves)';

-- =============================================================================
-- PATCH CAMPAIGN ASSETS
-- =============================================================================

-- Per-asset execution tracking
CREATE TABLE patch_campaign_assets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    campaign_id UUID NOT NULL REFERENCES patch_campaigns(id) ON DELETE CASCADE,
    phase_id UUID REFERENCES patch_campaign_phases(id) ON DELETE SET NULL,
    asset_id UUID NOT NULL REFERENCES assets(id) ON DELETE CASCADE,

    -- Status
    status VARCHAR(31) NOT NULL DEFAULT 'pending' CHECK (status IN (
        'pending',         -- Not started
        'queued',          -- In queue for execution
        'preflight',       -- Running preflight checks
        'in_progress',     -- Patch being applied
        'health_check',    -- Running health check
        'completed',       -- Successfully patched
        'failed',          -- Failed to patch
        'rolled_back',     -- Rolled back after failure
        'skipped'          -- Skipped (e.g., already patched)
    )),

    -- Execution details
    executor VARCHAR(63),                      -- ssm, azure_update_mgr, gcp_os_config, k8s_rollout
    execution_id VARCHAR(255),                 -- Platform-specific execution ID

    -- Before/after state
    before_version VARCHAR(127),
    after_version VARCHAR(127),
    before_packages JSONB,                     -- Snapshot of affected packages before
    after_packages JSONB,                      -- Snapshot after patching

    -- Health check
    health_check_passed BOOLEAN,
    health_check_results JSONB,
    health_check_attempts INT NOT NULL DEFAULT 0,

    -- Error handling
    error_message TEXT,
    error_code VARCHAR(63),
    retry_count INT NOT NULL DEFAULT 0,
    max_retries INT NOT NULL DEFAULT 3,

    -- Rollback info
    rollback_available BOOLEAN NOT NULL DEFAULT false,
    rollback_snapshot_id VARCHAR(255),         -- AMI, snapshot ID, etc.
    rolled_back_at TIMESTAMPTZ,
    rollback_reason TEXT,

    -- Timing
    queued_at TIMESTAMPTZ,
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,

    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    UNIQUE(campaign_id, asset_id)
);

COMMENT ON TABLE patch_campaign_assets IS 'Per-asset execution tracking within a patch campaign';

-- =============================================================================
-- PATCH ROLLBACKS
-- =============================================================================

-- History of rollback operations
CREATE TABLE patch_rollbacks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    campaign_id UUID NOT NULL REFERENCES patch_campaigns(id) ON DELETE CASCADE,
    phase_id UUID REFERENCES patch_campaign_phases(id) ON DELETE SET NULL,

    -- Trigger
    trigger_type VARCHAR(31) NOT NULL CHECK (trigger_type IN (
        'automatic',       -- Auto-triggered by failure threshold
        'manual',          -- Manually initiated
        'health_check',    -- Triggered by health check failure
        'timeout'          -- Triggered by timeout
    )),
    triggered_by VARCHAR(255),
    trigger_reason TEXT NOT NULL,

    -- Scope
    rollback_scope VARCHAR(31) NOT NULL CHECK (rollback_scope IN (
        'asset',           -- Single asset
        'phase',           -- Entire phase
        'campaign'         -- Entire campaign
    )),
    asset_ids UUID[] NOT NULL DEFAULT '{}',

    -- Status
    status VARCHAR(31) NOT NULL DEFAULT 'in_progress' CHECK (status IN (
        'in_progress',
        'completed',
        'failed',
        'partial'          -- Some assets rolled back, some failed
    )),

    -- Results
    total_assets INT NOT NULL DEFAULT 0,
    successful_rollbacks INT NOT NULL DEFAULT 0,
    failed_rollbacks INT NOT NULL DEFAULT 0,
    rollback_results JSONB,

    -- Timing
    started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    completed_at TIMESTAMPTZ,

    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

COMMENT ON TABLE patch_rollbacks IS 'History of rollback operations for patch campaigns';

-- =============================================================================
-- VULNERABILITY EVIDENCE
-- =============================================================================

-- Audit trail for compliance frameworks (SOC2, PCI-DSS, HIPAA, FedRAMP)
CREATE TABLE vulnerability_evidence (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

    -- Event type
    event_type VARCHAR(63) NOT NULL CHECK (event_type IN (
        -- Detection events
        'cve_detected',
        'cve_enriched',
        'blast_radius_calculated',

        -- Alert lifecycle
        'alert_created',
        'alert_assigned',
        'alert_acknowledged',
        'alert_escalated',
        'alert_resolved',
        'alert_dismissed',

        -- Campaign lifecycle
        'campaign_created',
        'campaign_approved',
        'campaign_started',
        'campaign_phase_started',
        'campaign_phase_completed',
        'campaign_completed',
        'campaign_failed',

        -- Remediation events
        'patch_started',
        'patch_completed',
        'patch_failed',
        'rollback_triggered',
        'rollback_completed',

        -- Health check events
        'health_check_started',
        'health_check_passed',
        'health_check_failed',

        -- SLA events
        'sla_warning',
        'sla_breached'
    )),

    -- Related entities
    cve_id VARCHAR(63),
    alert_id UUID REFERENCES cve_alerts(id) ON DELETE SET NULL,
    campaign_id UUID REFERENCES patch_campaigns(id) ON DELETE SET NULL,
    asset_id UUID REFERENCES assets(id) ON DELETE SET NULL,

    -- Event data
    event_data JSONB NOT NULL DEFAULT '{}',

    -- Actor
    actor_type VARCHAR(31) NOT NULL CHECK (actor_type IN ('system', 'user', 'automation', 'ai_agent')),
    actor_id VARCHAR(255),
    actor_name VARCHAR(255),

    -- Compliance mapping
    compliance_controls JSONB,                 -- Array of {framework, control_id, control_name}

    -- Timestamps
    event_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

COMMENT ON TABLE vulnerability_evidence IS 'Compliance audit trail for vulnerability management activities';
COMMENT ON COLUMN vulnerability_evidence.compliance_controls IS 'Mapped compliance controls: [{framework: "SOC2", control_id: "CC7.1", ...}]';

-- =============================================================================
-- CVE PACKAGE MATCHES
-- =============================================================================

-- Tracks which CVEs match which packages (for efficient cross-org matching)
CREATE TABLE cve_package_matches (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    cve_cache_id UUID NOT NULL REFERENCES cve_cache(id) ON DELETE CASCADE,

    -- Package matching criteria
    package_name VARCHAR(255) NOT NULL,
    package_type VARCHAR(63),                  -- deb, rpm, npm, pip, go, etc.
    version_start VARCHAR(127),                -- Affected version range start
    version_end VARCHAR(127),                  -- Affected version range end
    version_constraint VARCHAR(31) NOT NULL DEFAULT 'range' CHECK (version_constraint IN (
        'exact',           -- Exactly this version
        'range',           -- version_start <= v < version_end
        'less_than',       -- v < version_end
        'less_than_eq',    -- v <= version_end
        'all'              -- All versions
    )),

    -- Identifiers
    cpe_pattern VARCHAR(512),                  -- CPE match pattern
    purl_pattern VARCHAR(512),                 -- PURL match pattern

    -- Fix information
    fixed_version VARCHAR(127),
    fix_available BOOLEAN NOT NULL DEFAULT false,

    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    UNIQUE(cve_cache_id, package_name, package_type, version_start, version_end)
);

COMMENT ON TABLE cve_package_matches IS 'Maps CVEs to affected package name/version patterns for efficient matching';

-- =============================================================================
-- INDEXES
-- =============================================================================

-- CVE Feed Sources
CREATE INDEX idx_cve_feed_sources_enabled ON cve_feed_sources(enabled) WHERE enabled = true;

-- CVE Cache
CREATE INDEX idx_cve_cache_cve_id ON cve_cache(cve_id);
CREATE INDEX idx_cve_cache_severity ON cve_cache(severity);
CREATE INDEX idx_cve_cache_cvss_v3 ON cve_cache(cvss_v3_score DESC) WHERE cvss_v3_score IS NOT NULL;
CREATE INDEX idx_cve_cache_epss ON cve_cache(epss_score DESC) WHERE epss_score IS NOT NULL;
CREATE INDEX idx_cve_cache_exploit ON cve_cache(exploit_available) WHERE exploit_available = true;
CREATE INDEX idx_cve_cache_cisa_kev ON cve_cache(cisa_kev_listed) WHERE cisa_kev_listed = true;
CREATE INDEX idx_cve_cache_published ON cve_cache(published_date DESC);
CREATE INDEX idx_cve_cache_modified ON cve_cache(modified_date DESC);
CREATE INDEX idx_cve_cache_fetched ON cve_cache(fetched_at DESC);

-- CVE Alerts
CREATE INDEX idx_cve_alerts_org_id ON cve_alerts(org_id);
CREATE INDEX idx_cve_alerts_cve_id ON cve_alerts(cve_id);
CREATE INDEX idx_cve_alerts_status ON cve_alerts(status);
CREATE INDEX idx_cve_alerts_severity ON cve_alerts(severity);
CREATE INDEX idx_cve_alerts_urgency ON cve_alerts(urgency_score DESC);
CREATE INDEX idx_cve_alerts_priority ON cve_alerts(priority);
CREATE INDEX idx_cve_alerts_sla ON cve_alerts(sla_due_at) WHERE sla_breached = false AND status NOT IN ('resolved', 'dismissed');
CREATE INDEX idx_cve_alerts_detected ON cve_alerts(detected_at DESC);
CREATE INDEX idx_cve_alerts_production ON cve_alerts(org_id, production_assets_count DESC) WHERE production_assets_count > 0;

-- CVE Alert Affected Items
CREATE INDEX idx_cve_affected_alert_id ON cve_alert_affected_items(alert_id);
CREATE INDEX idx_cve_affected_package ON cve_alert_affected_items(package_id) WHERE package_id IS NOT NULL;
CREATE INDEX idx_cve_affected_image ON cve_alert_affected_items(image_id) WHERE image_id IS NOT NULL;
CREATE INDEX idx_cve_affected_asset ON cve_alert_affected_items(asset_id) WHERE asset_id IS NOT NULL;
CREATE INDEX idx_cve_affected_type ON cve_alert_affected_items(item_type);
CREATE INDEX idx_cve_affected_status ON cve_alert_affected_items(item_status);
CREATE INDEX idx_cve_affected_production ON cve_alert_affected_items(alert_id) WHERE is_production = true;

-- Patch Campaigns
CREATE INDEX idx_patch_campaigns_org_id ON patch_campaigns(org_id);
CREATE INDEX idx_patch_campaigns_status ON patch_campaigns(status);
CREATE INDEX idx_patch_campaigns_type ON patch_campaigns(campaign_type);
CREATE INDEX idx_patch_campaigns_scheduled ON patch_campaigns(scheduled_start_at) WHERE status IN ('approved', 'scheduled');
CREATE INDEX idx_patch_campaigns_active ON patch_campaigns(org_id) WHERE status IN ('in_progress', 'paused');

-- Patch Campaign Phases
CREATE INDEX idx_patch_phases_campaign ON patch_campaign_phases(campaign_id);
CREATE INDEX idx_patch_phases_status ON patch_campaign_phases(status);

-- Patch Campaign Assets
CREATE INDEX idx_patch_assets_campaign ON patch_campaign_assets(campaign_id);
CREATE INDEX idx_patch_assets_phase ON patch_campaign_assets(phase_id);
CREATE INDEX idx_patch_assets_asset ON patch_campaign_assets(asset_id);
CREATE INDEX idx_patch_assets_status ON patch_campaign_assets(status);
CREATE INDEX idx_patch_assets_pending ON patch_campaign_assets(campaign_id) WHERE status IN ('pending', 'queued');

-- Patch Rollbacks
CREATE INDEX idx_patch_rollbacks_campaign ON patch_rollbacks(campaign_id);
CREATE INDEX idx_patch_rollbacks_phase ON patch_rollbacks(phase_id);
CREATE INDEX idx_patch_rollbacks_status ON patch_rollbacks(status);

-- Vulnerability Evidence
CREATE INDEX idx_vuln_evidence_org ON vulnerability_evidence(org_id);
CREATE INDEX idx_vuln_evidence_type ON vulnerability_evidence(event_type);
CREATE INDEX idx_vuln_evidence_cve ON vulnerability_evidence(cve_id) WHERE cve_id IS NOT NULL;
CREATE INDEX idx_vuln_evidence_alert ON vulnerability_evidence(alert_id) WHERE alert_id IS NOT NULL;
CREATE INDEX idx_vuln_evidence_campaign ON vulnerability_evidence(campaign_id) WHERE campaign_id IS NOT NULL;
CREATE INDEX idx_vuln_evidence_event_at ON vulnerability_evidence(event_at DESC);
CREATE INDEX idx_vuln_evidence_compliance ON vulnerability_evidence USING gin(compliance_controls jsonb_path_ops);

-- CVE Package Matches
CREATE INDEX idx_cve_matches_cve ON cve_package_matches(cve_cache_id);
CREATE INDEX idx_cve_matches_package ON cve_package_matches(package_name, package_type);
CREATE INDEX idx_cve_matches_purl ON cve_package_matches(purl_pattern) WHERE purl_pattern IS NOT NULL;
CREATE INDEX idx_cve_matches_cpe ON cve_package_matches(cpe_pattern) WHERE cpe_pattern IS NOT NULL;

-- =============================================================================
-- TRIGGERS
-- =============================================================================

-- Auto-update updated_at
CREATE TRIGGER update_cve_feed_sources_updated_at
    BEFORE UPDATE ON cve_feed_sources
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_cve_cache_updated_at
    BEFORE UPDATE ON cve_cache
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_cve_alerts_updated_at
    BEFORE UPDATE ON cve_alerts
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_cve_affected_items_updated_at
    BEFORE UPDATE ON cve_alert_affected_items
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_patch_campaigns_updated_at
    BEFORE UPDATE ON patch_campaigns
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_patch_phases_updated_at
    BEFORE UPDATE ON patch_campaign_phases
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_patch_assets_updated_at
    BEFORE UPDATE ON patch_campaign_assets
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_cve_package_matches_updated_at
    BEFORE UPDATE ON cve_package_matches
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- =============================================================================
-- ROW LEVEL SECURITY
-- =============================================================================

ALTER TABLE cve_alerts ENABLE ROW LEVEL SECURITY;
ALTER TABLE cve_alert_affected_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE patch_campaigns ENABLE ROW LEVEL SECURITY;
ALTER TABLE patch_campaign_phases ENABLE ROW LEVEL SECURITY;
ALTER TABLE patch_campaign_assets ENABLE ROW LEVEL SECURITY;
ALTER TABLE patch_rollbacks ENABLE ROW LEVEL SECURITY;
ALTER TABLE vulnerability_evidence ENABLE ROW LEVEL SECURITY;

-- CVE Alerts: Org isolation
CREATE POLICY cve_alerts_org_isolation ON cve_alerts
    FOR ALL
    USING (org_id = current_setting('app.current_org_id')::UUID);

-- CVE Alert Affected Items: Via alert's org_id
CREATE POLICY cve_affected_org_isolation ON cve_alert_affected_items
    FOR ALL
    USING (
        EXISTS (
            SELECT 1 FROM cve_alerts
            WHERE cve_alerts.id = cve_alert_affected_items.alert_id
            AND cve_alerts.org_id = current_setting('app.current_org_id')::UUID
        )
    );

-- Patch Campaigns: Org isolation
CREATE POLICY patch_campaigns_org_isolation ON patch_campaigns
    FOR ALL
    USING (org_id = current_setting('app.current_org_id')::UUID);

-- Patch Campaign Phases: Via campaign's org_id
CREATE POLICY patch_phases_org_isolation ON patch_campaign_phases
    FOR ALL
    USING (
        EXISTS (
            SELECT 1 FROM patch_campaigns
            WHERE patch_campaigns.id = patch_campaign_phases.campaign_id
            AND patch_campaigns.org_id = current_setting('app.current_org_id')::UUID
        )
    );

-- Patch Campaign Assets: Via campaign's org_id
CREATE POLICY patch_assets_org_isolation ON patch_campaign_assets
    FOR ALL
    USING (
        EXISTS (
            SELECT 1 FROM patch_campaigns
            WHERE patch_campaigns.id = patch_campaign_assets.campaign_id
            AND patch_campaigns.org_id = current_setting('app.current_org_id')::UUID
        )
    );

-- Patch Rollbacks: Via campaign's org_id
CREATE POLICY patch_rollbacks_org_isolation ON patch_rollbacks
    FOR ALL
    USING (
        EXISTS (
            SELECT 1 FROM patch_campaigns
            WHERE patch_campaigns.id = patch_rollbacks.campaign_id
            AND patch_campaigns.org_id = current_setting('app.current_org_id')::UUID
        )
    );

-- Vulnerability Evidence: Org isolation
CREATE POLICY vuln_evidence_org_isolation ON vulnerability_evidence
    FOR ALL
    USING (org_id = current_setting('app.current_org_id')::UUID);

-- =============================================================================
-- VIEWS
-- =============================================================================

-- CVE Alert Summary (for dashboard)
CREATE OR REPLACE VIEW v_cve_alert_summary AS
SELECT
    ca.org_id,
    ca.status,
    ca.severity,
    ca.priority,
    COUNT(*) as alert_count,
    SUM(ca.affected_images_count) as total_affected_images,
    SUM(ca.affected_assets_count) as total_affected_assets,
    SUM(ca.production_assets_count) as total_production_assets,
    AVG(ca.urgency_score) as avg_urgency_score,
    COUNT(*) FILTER (WHERE ca.sla_breached) as sla_breached_count
FROM cve_alerts ca
GROUP BY ca.org_id, ca.status, ca.severity, ca.priority;

COMMENT ON VIEW v_cve_alert_summary IS 'Aggregated CVE alert statistics by status, severity, and priority';

-- Active CVE Alerts (for quick lookup)
CREATE OR REPLACE VIEW v_active_cve_alerts AS
SELECT
    ca.*,
    cc.cvss_v3_score,
    cc.epss_score,
    cc.exploit_available,
    cc.cisa_kev_listed,
    cc.description as cve_description
FROM cve_alerts ca
LEFT JOIN cve_cache cc ON cc.cve_id = ca.cve_id
WHERE ca.status NOT IN ('resolved', 'dismissed', 'auto_resolved');

COMMENT ON VIEW v_active_cve_alerts IS 'Active CVE alerts with enriched CVE details';

-- Patch Campaign Progress
CREATE OR REPLACE VIEW v_patch_campaign_progress AS
SELECT
    pc.id,
    pc.org_id,
    pc.name,
    pc.campaign_type,
    pc.status,
    pc.total_assets,
    pc.completed_assets,
    pc.failed_assets,
    pc.skipped_assets,
    CASE
        WHEN pc.total_assets = 0 THEN 0
        ELSE ROUND(100.0 * pc.completed_assets / pc.total_assets, 1)
    END as completion_percentage,
    CASE
        WHEN pc.total_assets = 0 THEN 0
        ELSE ROUND(100.0 * pc.failed_assets / pc.total_assets, 1)
    END as failure_percentage,
    (SELECT COUNT(*) FROM patch_campaign_phases WHERE campaign_id = pc.id) as total_phases,
    (SELECT COUNT(*) FROM patch_campaign_phases WHERE campaign_id = pc.id AND status = 'completed') as completed_phases,
    pc.started_at,
    pc.completed_at
FROM patch_campaigns pc;

COMMENT ON VIEW v_patch_campaign_progress IS 'Patch campaign progress with completion percentages';

-- Blast Radius by CVE
CREATE OR REPLACE VIEW v_cve_blast_radius AS
SELECT
    ca.id as alert_id,
    ca.org_id,
    ca.cve_id,
    ca.severity,
    ca.urgency_score,
    COUNT(DISTINCT cai.package_id) as unique_packages,
    COUNT(DISTINCT cai.image_id) as unique_images,
    COUNT(DISTINCT cai.asset_id) as unique_assets,
    COUNT(DISTINCT cai.asset_id) FILTER (WHERE cai.is_production) as production_assets,
    array_agg(DISTINCT cai.asset_platform) FILTER (WHERE cai.asset_platform IS NOT NULL) as affected_platforms,
    array_agg(DISTINCT cai.asset_region) FILTER (WHERE cai.asset_region IS NOT NULL) as affected_regions
FROM cve_alerts ca
LEFT JOIN cve_alert_affected_items cai ON cai.alert_id = ca.id
GROUP BY ca.id, ca.org_id, ca.cve_id, ca.severity, ca.urgency_score;

COMMENT ON VIEW v_cve_blast_radius IS 'Blast radius analysis for each CVE alert';
