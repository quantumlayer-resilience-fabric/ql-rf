-- QuantumLayer Resilience Fabric - Vulnerability Response System
-- Migration: 000017_add_vulnerability_response (DOWN)
-- Description: Rollback real-time CVE detection, blast radius analysis, and patch orchestration

-- =============================================================================
-- DROP VIEWS
-- =============================================================================

DROP VIEW IF EXISTS v_cve_blast_radius;
DROP VIEW IF EXISTS v_patch_campaign_progress;
DROP VIEW IF EXISTS v_active_cve_alerts;
DROP VIEW IF EXISTS v_cve_alert_summary;

-- =============================================================================
-- DROP POLICIES
-- =============================================================================

DROP POLICY IF EXISTS vuln_evidence_org_isolation ON vulnerability_evidence;
DROP POLICY IF EXISTS patch_rollbacks_org_isolation ON patch_rollbacks;
DROP POLICY IF EXISTS patch_assets_org_isolation ON patch_campaign_assets;
DROP POLICY IF EXISTS patch_phases_org_isolation ON patch_campaign_phases;
DROP POLICY IF EXISTS patch_campaigns_org_isolation ON patch_campaigns;
DROP POLICY IF EXISTS cve_affected_org_isolation ON cve_alert_affected_items;
DROP POLICY IF EXISTS cve_alerts_org_isolation ON cve_alerts;

-- =============================================================================
-- DROP TRIGGERS
-- =============================================================================

DROP TRIGGER IF EXISTS update_cve_package_matches_updated_at ON cve_package_matches;
DROP TRIGGER IF EXISTS update_patch_assets_updated_at ON patch_campaign_assets;
DROP TRIGGER IF EXISTS update_patch_phases_updated_at ON patch_campaign_phases;
DROP TRIGGER IF EXISTS update_patch_campaigns_updated_at ON patch_campaigns;
DROP TRIGGER IF EXISTS update_cve_affected_items_updated_at ON cve_alert_affected_items;
DROP TRIGGER IF EXISTS update_cve_alerts_updated_at ON cve_alerts;
DROP TRIGGER IF EXISTS update_cve_cache_updated_at ON cve_cache;
DROP TRIGGER IF EXISTS update_cve_feed_sources_updated_at ON cve_feed_sources;

-- =============================================================================
-- DROP FOREIGN KEY FROM CVE ALERTS
-- =============================================================================

ALTER TABLE cve_alerts DROP CONSTRAINT IF EXISTS fk_cve_alerts_patch_campaign;

-- =============================================================================
-- DROP TABLES (in reverse dependency order)
-- =============================================================================

DROP TABLE IF EXISTS cve_package_matches;
DROP TABLE IF EXISTS vulnerability_evidence;
DROP TABLE IF EXISTS patch_rollbacks;
DROP TABLE IF EXISTS patch_campaign_assets;
DROP TABLE IF EXISTS patch_campaign_phases;
DROP TABLE IF EXISTS patch_campaigns;
DROP TABLE IF EXISTS cve_alert_affected_items;
DROP TABLE IF EXISTS cve_alerts;
DROP TABLE IF EXISTS cve_cache;
DROP TABLE IF EXISTS cve_feed_sources;
